<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mastery Tracker v3 (Alpine)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .card-shadow { box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.1); }
        .ingested-row { opacity: 0.5; filter: grayscale(1); }
        .ingested-text { text-decoration: line-through; color: #94a3b8; }
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen font-sans">

<div x-data="masteryApp()" x-cloak class="max-w-7xl mx-auto px-4 py-8 lg:px-8">
    
    <!-- Header -->
    <header class="mb-10">
        <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-8">
            <div>
                <h1 class="text-3xl font-bold text-slate-800 tracking-tight">Mastery Optimization Dashboard (Alpine)</h1>
                <p class="text-slate-500 mt-1">Brown University's Warren Alpert Medical School Learning System</p>
                <div class="mt-6 flex items-center gap-3">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Current Block:</label>
                    <div class="flex items-center gap-2">
                        <select x-model="activeBlockId" @change="handleBlockChange($event)" class="bg-white border border-slate-200 text-slate-700 text-sm font-bold rounded-xl focus:ring-indigo-500 focus:border-indigo-500 block p-2.5 min-w-[200px] shadow-sm">
                            <option value="all">All Blocks (Longitudinal)</option>
                            <template x-for="block in blocks" :key="block.id">
                                <option :value="block.id" x-text="block.name"></option>
                            </template>
                            <option value="new_block_action" class="font-bold text-indigo-600">+ New Block...</option>
                        </select>
                        <template x-if="activeBlockId !== 'all'">
                            <button @click="renameBlock" class="p-2 text-slate-400 hover:text-indigo-600 hover:bg-slate-100 rounded-lg transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                            </button>
                        </template>
                    </div>
                </div>
            </div>
            
            <div class="flex flex-wrap gap-4">
                <div class="bg-white p-4 rounded-2xl card-shadow border border-slate-100 min-w-[160px] relative group">
                    <p class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Harmonic Mean (Mh)</p>
                    <div class="flex items-baseline gap-2">
                        <p class="text-3xl font-bold text-indigo-600" x-text="mh"></p>
                        <p class="text-xs font-bold text-slate-300" x-text="'/ ' + (activeBlock ? activeBlock.masteryGoal : '(Global)')"></p>
                    </div>
                    <template x-if="activeBlockId !== 'all'">
                        <button @click="modals.goal = true" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-[10px] font-black text-indigo-400 hover:text-indigo-600 uppercase">Set Goal</button>
                    </template>
                </div>
                <div class="bg-white p-4 rounded-2xl card-shadow border border-slate-100 min-w-[140px]">
                    <p class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Lecture Coverage</p>
                    <p class="text-3xl font-bold text-blue-500" x-text="ingestedCount + ' / ' + activeLectures.length"></p>
                </div>
                <div class="bg-white p-4 rounded-2xl card-shadow border border-slate-100 min-w-[140px]">
                    <p class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Topics Mastered</p>
                    <p class="text-3xl font-bold text-emerald-500" x-text="masteredCount + ' / ' + activeTopics.length"></p>
                </div>
            </div>
        </div>

        <!-- Goal Bar -->
        <template x-if="activeBlock && activeBlock.masteryGoal > 0">
            <div class="bg-white p-5 rounded-2xl card-shadow border border-slate-100">
                <div class="flex justify-between items-center mb-2">
                    <p class="text-xs font-bold text-slate-500 uppercase tracking-widest">Block Mastery Progress</p>
                    <p class="text-xs font-black text-indigo-600" x-text="Math.min(100, Math.round((mh / activeBlock.masteryGoal) * 100)) + '%'"></p>
                </div>
                <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden">
                    <div class="bg-indigo-600 h-full transition-all duration-1000" :style="`width: ${Math.min(100, Math.round((mh / activeBlock.masteryGoal) * 100))}%`"></div>
                </div>
            </div>
        </template>
    </header>

    <!-- Toolbar -->
    <div class="mb-6 flex flex-wrap gap-3">
        <button @click="exportData" class="bg-white border border-slate-200 px-4 py-2 rounded-xl text-xs font-bold text-slate-600 hover:bg-slate-50 flex items-center gap-2">Export Backup</button>
        <label class="bg-white border border-slate-200 px-4 py-2 rounded-xl text-xs font-bold text-slate-600 hover:bg-slate-50 flex items-center gap-2 cursor-pointer">
            Restore Backup
            <input type="file" class="hidden" accept=".json" @change="importData">
        </label>
        <button @click="clearAllData" class="bg-red-50 border border-red-100 px-4 py-2 rounded-xl text-xs font-bold text-red-600 hover:bg-red-100">Clear All Data</button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <!-- Sidebar -->
        <aside class="lg:col-span-3 space-y-6">
            <nav class="bg-white rounded-2xl card-shadow border border-slate-100 overflow-hidden">
                <template x-for="item in [{id: 'dashboard', label: 'Topic Mastery'}, {id: 'checklist', label: 'Lecture Checklist'}, {id: 'lectures', label: 'Lecture Catalog'}, {id: 'history', label: 'Pass History'}]">
                    <button @click="currentView = item.id" 
                        class="w-full text-left px-6 py-4 font-medium flex items-center gap-3 transition-all"
                        :class="currentView === item.id ? 'bg-indigo-50 text-indigo-700 border-l-4 border-indigo-600' : 'hover:bg-slate-50 text-slate-600'"
                        x-text="item.label">
                    </button>
                </template>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="lg:col-span-9">
            
            <!-- Dashboard View -->
            <section x-show="currentView === 'dashboard'" class="space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-slate-800">Topic Master List</h2>
                    <template x-if="activeBlockId !== 'all'">
                        <button @click="openAddTopic" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-xl text-sm font-semibold">Add Topic</button>
                    </template>
                </div>
                <div class="bg-white rounded-2xl card-shadow border border-slate-100 overflow-hidden">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-slate-50 border-b border-slate-100">
                                <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider">Topic</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-center">Mi</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <template x-for="topic in sortedTopics" :key="topic.id">
                                <tr>
                                    <td class="px-6 py-4 font-bold text-slate-800">
                                        <span x-text="topic.name"></span>
                                        <template x-for="tag in (topic.tags || [])">
                                            <span x-text="tag" class="ml-2 text-[9px] px-1.5 py-0.5 bg-slate-100 text-slate-500 rounded font-mono"></span>
                                        </template>
                                    </td>
                                    <td class="text-center">
                                        <span x-text="getTopicStats(topic.id).mi" class="px-3 py-1 rounded-full text-xs font-bold"
                                            :class="getTopicStats(topic.id).mi >= 7 ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-700'"></span>
                                    </td>
                                    <td class="text-right px-6 space-x-2">
                                        <button @click="openEditTopic(topic)" class="text-indigo-300 hover:text-indigo-600 text-[10px] font-bold uppercase">Edit</button>
                                        <button @click="deleteTopic(topic.id)" class="text-slate-300 hover:text-red-500 text-lg">×</button>
                                    </td>
                                </tr>
                            </template>
                            <template x-if="activeTopics.length === 0">
                                <tr><td colspan="3" class="px-6 py-8 text-center text-slate-400">No topics.</td></tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Checklist View -->
            <section x-show="currentView === 'checklist'" class="space-y-6">
                <h2 class="text-xl font-bold text-slate-800">Ingestion Checklist</h2>
                <div class="bg-white rounded-2xl card-shadow border border-slate-100 overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-6 py-4 w-12 text-center">Status</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase">Lecture</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase">Topics</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase text-right">Date</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <template x-for="lecture in sortedLectures" :key="lecture.id">
                                <tr :class="lecture.ingested ? 'ingested-row' : ''">
                                    <td class="px-6 py-4 text-center">
                                        <input type="checkbox" x-model="lecture.ingested" @change="save()" class="w-5 h-5 cursor-pointer text-blue-600 rounded">
                                    </td>
                                    <td class="px-6 py-4 font-bold text-slate-800" :class="lecture.ingested ? 'ingested-text' : ''" x-text="lecture.title"></td>
                                    <td class="px-6 py-4">
                                        <template x-for="tid in lecture.topics">
                                            <span x-text="getTopicName(tid)" class="bg-indigo-50 text-indigo-600 text-[10px] px-2 py-0.5 rounded mr-1"></span>
                                        </template>
                                    </td>
                                    <td class="px-6 py-4 text-right text-xs text-slate-400 font-mono" x-text="lecture.date"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Lectures View -->
            <section x-show="currentView === 'lectures'" class="space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold">Lecture Catalog</h2>
                    <template x-if="activeBlockId !== 'all'">
                        <button @click="openAddLecture" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-sm font-semibold">Add Lecture</button>
                    </template>
                </div>
                <div class="bg-white p-4 rounded-2xl card-shadow border border-slate-100">
                    <input type="text" x-model="lectureSearch" placeholder="Search lectures..." class="w-full px-3 py-2 text-sm rounded-lg border border-slate-200 focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <template x-for="l in filteredLectures" :key="l.id">
                        <div class="bg-white p-4 rounded-2xl border border-slate-100 card-shadow relative group" :class="l.ingested ? 'opacity-60 grayscale-[0.5]' : ''">
                            <div class="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button @click="openEditLecture(l)" class="text-indigo-400 hover:text-indigo-600 text-[10px] font-bold">EDIT</button>
                                <button @click="deleteLecture(l.id)" class="text-red-300 hover:text-red-500">×</button>
                            </div>
                            <div class="flex items-start gap-2 pr-12">
                                <template x-if="l.ingested"><span class="text-emerald-500 font-bold text-lg">✓</span></template>
                                <div>
                                    <p class="font-bold text-slate-800" :class="l.ingested ? 'line-through' : ''" x-text="l.title"></p>
                                    <p class="text-[10px] text-slate-400 font-bold uppercase" x-text="l.date"></p>
                                </div>
                            </div>
                            <div class="mt-3 flex flex-wrap gap-1">
                                <template x-for="tid in l.topics">
                                    <span x-text="getTopicName(tid)" class="bg-indigo-50 text-indigo-600 text-[9px] px-1.5 py-0.5 rounded font-bold"></span>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </section>

            <!-- History View -->
            <section x-show="currentView === 'history'" class="space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold">Pass History</h2>
                    <template x-if="activeBlockId !== 'all'">
                        <button @click="openLogPass" class="bg-emerald-600 text-white px-4 py-2 rounded-xl text-sm font-semibold">Log New Pass</button>
                    </template>
                </div>
                <div class="bg-white rounded-2xl card-shadow border border-slate-100 overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase">Date</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase">Topic</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase text-center">Sp3/Quiz</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase text-center">Mi</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase">Notes</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <template x-for="p in sortedHistory" :key="p.id">
                                <tr class="hover:bg-slate-50 transition-colors">
                                    <td class="px-6 py-3 text-xs text-slate-500 whitespace-nowrap" x-text="p.date"></td>
                                    <td class="px-6 py-3 text-xs font-bold text-slate-800" x-text="getTopicName(p.topicId)"></td>
                                    <td class="text-center text-xs font-medium" x-text="p.sp3 + ' / ' + p.quiz"></td>
                                    <td class="text-center text-xs font-bold text-indigo-600" x-text="((0.7*p.sp3)+(0.3*p.quiz)).toFixed(2)"></td>
                                    <td class="px-6 py-3 text-[11px] text-slate-500 max-w-xs italic" x-text="p.note"></td>
                                    <td class="text-right px-6 space-x-2">
                                        <button @click="openEditPass(p)" class="text-indigo-300 hover:text-indigo-600 text-[10px] font-bold uppercase">Edit</button>
                                        <button @click="deletePass(p.id)" class="text-red-200 hover:text-red-500 text-[10px] font-bold uppercase">Del</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals (using x-model) -->

    <!-- Topic Modal -->
    <div x-show="modals.topic" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-md p-8 shadow-2xl">
            <h3 class="text-2xl font-bold mb-6 text-slate-800" x-text="editingId ? 'Edit Topic' : 'New Master Topic'"></h3>
            <form @submit.prevent="saveTopic" class="space-y-4">
                <input type="text" x-model="forms.topic.name" required class="w-full px-4 py-3 rounded-xl border border-slate-200" placeholder="Topic Name">
                <input type="text" x-model="forms.topic.subject" class="w-full px-4 py-3 rounded-xl border border-slate-200" placeholder="Subject">
                <input type="text" x-model="forms.topic.tags" class="w-full px-4 py-3 rounded-xl border border-slate-200" placeholder="Tags (comma sep)">
                <div class="flex gap-3">
                    <button type="button" @click="modals.topic = false" class="flex-1 py-3 border border-slate-200 rounded-xl font-bold">Cancel</button>
                    <button type="submit" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Lecture Modal -->
    <div x-show="modals.lecture" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-md p-8 shadow-2xl">
            <h3 class="text-2xl font-bold mb-6 text-slate-800" x-text="editingId ? 'Edit Lecture' : 'Add Lecture'"></h3>
            <form @submit.prevent="saveLecture" class="space-y-4">
                <input type="text" x-model="forms.lecture.title" required class="w-full px-4 py-3 rounded-xl border border-slate-200" placeholder="Title">
                <input type="date" x-model="forms.lecture.date" required class="w-full px-4 py-3 rounded-xl border border-slate-200">
                <label class="block text-[10px] font-bold text-slate-400 uppercase">Relevant Topics</label>
                <div class="max-h-40 overflow-y-auto border border-slate-200 rounded-xl p-3 custom-scroll">
                    <template x-for="t in activeTopics" :key="t.id">
                        <label class="flex items-center gap-2 p-1 hover:bg-slate-50 cursor-pointer text-sm">
                            <input type="checkbox" :value="t.id" x-model="forms.lecture.topics" class="w-4 h-4 text-indigo-600 rounded">
                            <span x-text="t.name"></span>
                        </label>
                    </template>
                    <template x-if="activeTopics.length === 0"><p class="text-xs italic text-slate-400">No topics.</p></template>
                </div>
                <div class="flex gap-3">
                    <button type="button" @click="modals.lecture = false" class="flex-1 py-3 border border-slate-200 rounded-xl font-bold">Cancel</button>
                    <button type="submit" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Pass Modal -->
    <div x-show="modals.pass" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-md p-8 shadow-2xl">
            <h3 class="text-2xl font-bold mb-6 text-slate-800" x-text="editingId ? 'Edit Pass' : 'Log Pass'"></h3>
            <form @submit.prevent="savePass" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Topic</label>
                    <select x-model="forms.pass.topicId" required class="w-full px-4 py-3 rounded-xl border border-slate-200">
                         <template x-for="t in activeTopics" :key="t.id">
                             <option :value="t.id" x-text="t.name"></option>
                         </template>
                    </select>
                </div>
                <input type="date" x-model="forms.pass.date" required class="w-full px-4 py-3 rounded-xl border border-slate-200">
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" step="0.1" min="0" max="10" x-model="forms.pass.sp3" required placeholder="Sp3" class="w-full px-4 py-3 rounded-xl border border-slate-200">
                    <input type="number" step="0.1" min="0" max="10" x-model="forms.pass.quiz" required placeholder="Quiz" class="w-full px-4 py-3 rounded-xl border border-slate-200">
                </div>
                <textarea x-model="forms.pass.note" rows="3" class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm" placeholder="Sprint Notes..."></textarea>
                <div class="flex gap-3">
                    <button type="button" @click="modals.pass = false" class="flex-1 py-3 border border-slate-200 rounded-xl font-bold">Cancel</button>
                    <button type="submit" class="flex-1 bg-emerald-600 text-white py-3 rounded-xl font-bold">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Block Modal -->
    <div x-show="modals.block" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-8 shadow-2xl">
            <h3 class="text-2xl font-bold mb-4 text-slate-800">New Block</h3>
            <form @submit.prevent="saveBlock">
                <input type="text" x-model="forms.block.name" required class="w-full px-4 py-3 rounded-xl border border-slate-200 mb-4" placeholder="Block Name">
                <div class="flex gap-3">
                    <button type="button" @click="modals.block = false" class="flex-1 py-3 border border-slate-200 rounded-xl font-bold">Cancel</button>
                    <button type="submit" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold">Create</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Goal Modal -->
    <div x-show="modals.goal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-8 shadow-2xl">
            <h3 class="text-2xl font-bold mb-4 text-slate-800">Set Goal</h3>
            <form @submit.prevent="saveGoal">
                <input type="number" step="0.1" max="10" x-model="forms.goal.mh" required class="w-full px-4 py-3 rounded-xl border border-slate-200 mb-4" placeholder="Target Mh">
                <div class="flex gap-3">
                    <button type="button" @click="modals.goal = false" class="flex-1 py-3 border border-slate-200 rounded-xl font-bold">Cancel</button>
                    <button type="submit" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold">Save</button>
                </div>
            </form>
        </div>
    </div>

</div>

<script>
    function masteryApp() {
        return {
            blocks: [],
            activeBlockId: null,
            topics: [],
            lectures: [],
            passes: [],
            
            // UI State
            currentView: 'dashboard',
            lectureSearch: '',
            modals: { topic: false, lecture: false, pass: false, block: false, goal: false },
            editingId: null,
            forms: {
                topic: { name: '', subject: '', tags: '' },
                lecture: { title: '', date: '', topics: [] },
                pass: { topicId: '', date: '', sp3: '', quiz: '', note: '' },
                block: { name: '' },
                goal: { mh: '' }
            },

            init() {
                const saved = localStorage.getItem('med_mastery_v2');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if (!parsed.blocks) this.resetState();
                        else {
                            this.blocks = parsed.blocks;
                            this.activeBlockId = parsed.activeBlockId;
                            this.topics = parsed.topics;
                            this.lectures = parsed.lectures;
                            this.passes = parsed.passes;
                        }
                    } catch (e) { this.resetState(); }
                } else {
                    this.resetState();
                }
            },

            resetState() {
                const defaultBlockId = 'b-' + Date.now();
                this.blocks = [{ id: defaultBlockId, name: "Block 1", masteryGoal: 0 }];
                this.activeBlockId = defaultBlockId;
                this.topics = [];
                this.lectures = [];
                this.passes = [];
                this.save();
            },

            save() {
                localStorage.setItem('med_mastery_v2', JSON.stringify({
                    blocks: this.blocks,
                    activeBlockId: this.activeBlockId,
                    topics: this.topics,
                    lectures: this.lectures,
                    passes: this.passes
                }));
            },

            // Computed Helpers
            get activeBlock() {
                return this.activeBlockId === 'all' ? null : this.blocks.find(b => b.id === this.activeBlockId);
            },
            get activeTopics() {
                return this.activeBlockId === 'all' ? this.topics : this.topics.filter(t => t.blockId === this.activeBlockId);
            },
            get activeLectures() {
                return this.activeBlockId === 'all' ? this.lectures : this.lectures.filter(l => l.blockId === this.activeBlockId);
            },
            get sortedTopics() {
                return [...this.activeTopics].sort((a,b) => this.getTopicStats(a.id).mi - this.getTopicStats(b.id).mi);
            },
            get sortedLectures() {
                let filtered = this.activeLectures;
                if(this.lectureSearch) filtered = filtered.filter(l => l.title.toLowerCase().includes(this.lectureSearch.toLowerCase()));
                return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
            },
            get sortedHistory() {
                 const activeIds = new Set(this.activeTopics.map(t => t.id));
                 return this.passes.filter(p => activeIds.has(p.topicId)).sort((a, b) => new Date(b.date) - new Date(a.date));
            },
            get mh() {
                const mis = this.activeTopics.map(t => parseFloat(this.getTopicStats(t.id).mi)).filter(mi => mi > 0);
                return mis.length === 0 ? 0 : (mis.length / mis.reduce((acc, mi) => acc + (1/mi), 0)).toFixed(2);
            },
            get ingestedCount() {
                return this.activeLectures.filter(l => l.ingested).length;
            },
            get masteredCount() {
                return this.activeTopics.filter(t => parseFloat(this.getTopicStats(t.id).mi) >= 7).length;
            },
            get filteredLectures() {
                return this.sortedLectures; // Reuse sorted logic
            },

            getTopicStats(topicId) {
                const topicPasses = this.passes.filter(p => p.topicId === topicId);
                if (topicPasses.length === 0) return { mi: 0 };
                const avgSp3 = topicPasses.reduce((acc, p) => acc + p.sp3, 0) / topicPasses.length;
                const avgQuiz = topicPasses.reduce((acc, p) => acc + p.quiz, 0) / topicPasses.length;
                return { mi: ((0.7 * avgSp3) + (0.3 * avgQuiz)).toFixed(2) };
            },

            getTopicName(id) {
                const t = this.topics.find(x => x.id === id);
                return t ? t.name : 'Unknown';
            },

            // Actions
            handleBlockChange(e) {
                const val = e.target.value;
                if (val === 'new_block_action') {
                    this.modals.block = true;
                    // Reset selection visually until confirmed, simplified by binding
                    e.target.value = this.activeBlockId; 
                } else {
                    this.activeBlockId = val;
                    this.save();
                }
            },

            saveBlock() {
                const newId = 'b-' + Date.now();
                this.blocks.push({ id: newId, name: this.forms.block.name, masteryGoal: 0 });
                this.activeBlockId = newId;
                this.modals.block = false;
                this.save();
            },

            renameBlock() {
                const newName = prompt("Rename Block:", this.activeBlock.name);
                if(newName) {
                    this.activeBlock.name = newName.trim();
                    this.save();
                }
            },

            saveGoal() {
                if(this.activeBlock) {
                    this.activeBlock.masteryGoal = parseFloat(this.forms.goal.mh);
                    this.save();
                }
                this.modals.goal = false;
            },

            // Topic Actions
            openAddTopic() {
                this.editingId = null;
                this.forms.topic = { name: '', subject: '', tags: '' };
                this.modals.topic = true;
            },
            openEditTopic(t) {
                this.editingId = t.id;
                this.forms.topic = { name: t.name, subject: t.subject, tags: (t.tags||[]).join(', ') };
                this.modals.topic = true;
            },
            saveTopic() {
                const tags = this.forms.topic.tags.split(',').map(t => t.trim()).filter(Boolean);
                if(this.editingId) {
                    const t = this.topics.find(x => x.id === this.editingId);
                    t.name = this.forms.topic.name;
                    t.subject = this.forms.topic.subject;
                    t.tags = tags;
                } else {
                    this.topics.push({
                        id: 't'+Date.now(),
                        blockId: this.activeBlockId,
                        name: this.forms.topic.name,
                        subject: this.forms.topic.subject,
                        tags: tags
                    });
                }
                this.save();
                this.modals.topic = false;
            },
            deleteTopic(id) {
                if(confirm("Delete topic?")) {
                    this.topics = this.topics.filter(t => t.id !== id);
                    this.passes = this.passes.filter(p => p.topicId !== id);
                    this.save();
                }
            },

            // Lecture Actions
            openAddLecture() {
                this.editingId = null;
                this.forms.lecture = { title: '', date: new Date().toISOString().split('T')[0], topics: [] };
                this.modals.lecture = true;
            },
            openEditLecture(l) {
                this.editingId = l.id;
                // copy to avoid reactive mutation during edit
                this.forms.lecture = { title: l.title, date: l.date, topics: [...l.topics] }; 
                this.modals.lecture = true;
            },
            saveLecture() {
                if(this.editingId) {
                    const l = this.lectures.find(x => x.id === this.editingId);
                    l.title = this.forms.lecture.title;
                    l.date = this.forms.lecture.date;
                    l.topics = this.forms.lecture.topics;
                } else {
                    this.lectures.push({
                        id: 'l'+Date.now(),
                        blockId: this.activeBlockId,
                        title: this.forms.lecture.title,
                        date: this.forms.lecture.date,
                        topics: this.forms.lecture.topics,
                        ingested: false
                    });
                }
                this.save();
                this.modals.lecture = false;
            },
            deleteLecture(id) {
                if(confirm("Delete lecture?")) {
                    this.lectures = this.lectures.filter(l => l.id !== id);
                    this.save();
                }
            },

            // Pass Actions
            openLogPass() {
                this.editingId = null;
                this.forms.pass = { topicId: this.activeTopics[0]?.id || '', date: new Date().toISOString().split('T')[0], sp3: '', quiz: '', note: '' };
                this.modals.pass = true;
            },
            openEditPass(p) {
                this.editingId = p.id;
                this.forms.pass = { topicId: p.topicId, date: p.date, sp3: p.sp3, quiz: p.quiz, note: p.note };
                this.modals.pass = true;
            },
            savePass() {
                const data = {
                    topicId: this.forms.pass.topicId,
                    date: this.forms.pass.date,
                    sp3: parseFloat(this.forms.pass.sp3),
                    quiz: parseFloat(this.forms.pass.quiz),
                    note: this.forms.pass.note
                };
                if(this.editingId) {
                    const p = this.passes.find(x => x.id === this.editingId);
                    Object.assign(p, data);
                } else {
                    this.passes.push({ id: 'p'+Date.now(), ...data });
                }
                this.save();
                this.modals.pass = false;
            },
            deletePass(id) {
                if(confirm("Delete pass?")) {
                    this.passes = this.passes.filter(p => p.id !== id);
                    this.save();
                }
            },

            exportData() {
                const blob = new Blob([JSON.stringify({ blocks: this.blocks, activeBlockId: this.activeBlockId, topics: this.topics, lectures: this.lectures, passes: this.passes }, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Mastery_Backup_${new Date().toISOString()}.json`;
                a.click();
            },
            
            importData(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const parsed = JSON.parse(event.target.result);
                        if (!parsed.blocks) throw new Error("Invalid");
                        this.blocks = parsed.blocks;
                        this.activeBlockId = parsed.activeBlockId;
                        this.topics = parsed.topics;
                        this.lectures = parsed.lectures;
                        this.passes = parsed.passes;
                        this.save();
                    } catch(err) { alert("Invalid file"); }
                };
                reader.readAsText(file);
            },
            
            clearAllData() {
                if(confirm("Clear ALL data?")) this.resetState();
            }
        }
    }
</script>
</body>
</html>