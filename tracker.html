<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mastery Optimization Tracker</title>
    <style id="tailwind-inline">*,:after,:before{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/*! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com*/*,:after,:before{box-sizing:border-box;border:0 solid #e5e7eb}:after,:before{--tw-content:""}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;-o-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0}fieldset,legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{opacity:1;color:#9ca3af}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.inset-0{inset:0}.right-2{right:.5rem}.top-2{top:.5rem}.z-50{z-index:50}.col-span-full{grid-column:1/-1}.mx-auto{margin-left:auto;margin-right:auto}.mb-1{margin-bottom:.25rem}.mb-10{margin-bottom:2.5rem}.mb-2{margin-bottom:.5rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.ml-2{margin-left:.5rem}.mr-1{margin-right:.25rem}.mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mt-3{margin-top:.75rem}.mt-6{margin-top:1.5rem}.\!block{display:block!important}.block{display:block}.flex{display:flex}.table{display:table}.grid{display:grid}.hidden{display:none}.h-3{height:.75rem}.h-4{height:1rem}.h-5{height:1.25rem}.h-full{height:100%}.min-h-screen{min-height:100vh}.w-12{width:3rem}.w-4{width:1rem}.w-5{width:1.25rem}.w-full{width:100%}.min-w-\[140px\]{min-width:140px}.min-w-\[150px\]{min-width:150px}.min-w-\[160px\]{min-width:160px}.min-w-\[200px\]{min-width:200px}.max-w-7xl{max-width:80rem}.max-w-md{max-width:28rem}.max-w-sm{max-width:24rem}.max-w-xs{max-width:20rem}.flex-1{flex:1 1 0%}.flex-shrink{flex-shrink:1}.cursor-pointer{cursor:pointer}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-end{align-items:flex-end}.items-center{align-items:center}.items-baseline{align-items:baseline}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-1{gap:.25rem}.gap-2{gap:.5rem}.gap-3{gap:.75rem}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.gap-8{gap:2rem}.space-x-2>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-right:calc(.5rem*var(--tw-space-x-reverse));margin-left:calc(.5rem*(1 - var(--tw-space-x-reverse)))}.space-y-4>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem*var(--tw-space-y-reverse))}.space-y-6>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1.5rem*(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1.5rem*var(--tw-space-y-reverse))}.divide-y>:not([hidden])~:not([hidden]){--tw-divide-y-reverse:0;border-top-width:calc(1px*(1 - var(--tw-divide-y-reverse)));border-bottom-width:calc(1px*var(--tw-divide-y-reverse))}.divide-slate-100>:not([hidden])~:not([hidden]){--tw-divide-opacity:1;border-color:rgb(241 245 249/var(--tw-divide-opacity,1))}.overflow-hidden{overflow:hidden}.overflow-x-auto{overflow-x:auto}.overflow-y-auto{overflow-y:auto}.whitespace-nowrap{white-space:nowrap}.break-words{overflow-wrap:break-word}.rounded{border-radius:.25rem}.rounded-2xl{border-radius:1rem}.rounded-3xl{border-radius:1.5rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:.5rem}.rounded-xl{border-radius:.75rem}.border{border-width:1px}.border-y{border-top-width:1px}.border-b,.border-y{border-bottom-width:1px}.border-l-4{border-left-width:4px}.border-indigo-600{--tw-border-opacity:1;border-color:rgb(79 70 229/var(--tw-border-opacity,1))}.border-red-100{--tw-border-opacity:1;border-color:rgb(254 226 226/var(--tw-border-opacity,1))}.border-slate-100{--tw-border-opacity:1;border-color:rgb(241 245 249/var(--tw-border-opacity,1))}.border-slate-200{--tw-border-opacity:1;border-color:rgb(226 232 240/var(--tw-border-opacity,1))}.border-white\/20{border-color:hsla(0,0%,100%,.2)}.bg-emerald-100{--tw-bg-opacity:1;background-color:rgb(209 250 229/var(--tw-bg-opacity,1))}.bg-emerald-600{--tw-bg-opacity:1;background-color:rgb(5 150 105/var(--tw-bg-opacity,1))}.bg-indigo-50{--tw-bg-opacity:1;background-color:rgb(238 242 255/var(--tw-bg-opacity,1))}.bg-indigo-600{--tw-bg-opacity:1;background-color:rgb(79 70 229/var(--tw-bg-opacity,1))}.bg-red-50{--tw-bg-opacity:1;background-color:rgb(254 242 242/var(--tw-bg-opacity,1))}.bg-slate-100{--tw-bg-opacity:1;background-color:rgb(241 245 249/var(--tw-bg-opacity,1))}.bg-slate-100\/80{background-color:rgba(241,245,249,.8)}.bg-slate-50{--tw-bg-opacity:1;background-color:rgb(248 250 252/var(--tw-bg-opacity,1))}.bg-slate-900\/50{background-color:rgba(15,23,42,.5)}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255/var(--tw-bg-opacity,1))}.bg-white\/10{background-color:hsla(0,0%,100%,.1)}.p-1{padding:.25rem}.p-2{padding:.5rem}.p-2\.5{padding:.625rem}.p-3{padding:.75rem}.p-4{padding:1rem}.p-5{padding:1.25rem}.p-6{padding:1.5rem}.p-8{padding:2rem}.px-1{padding-left:.25rem;padding-right:.25rem}.px-1\.5{padding-left:.375rem;padding-right:.375rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.px-4{padding-left:1rem;padding-right:1rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.py-0\.5{padding-top:.125rem;padding-bottom:.125rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-10{padding-top:2.5rem;padding-bottom:2.5rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.py-8{padding-top:2rem;padding-bottom:2rem}.pl-10{padding-left:2.5rem}.pr-12{padding-right:3rem}.pt-2{padding-top:.5rem}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}.font-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}.font-sans{font-family:ui-sans-serif,system-ui,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-\[10px\]{font-size:10px}.text-\[11px\]{font-size:11px}.text-\[9px\]{font-size:9px}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:.75rem;line-height:1rem}.font-black{font-weight:900}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-semibold{font-weight:600}.uppercase{text-transform:uppercase}.italic{font-style:italic}.leading-relaxed{line-height:1.625}.tracking-tight{letter-spacing:-.025em}.tracking-wider{letter-spacing:.05em}.tracking-widest{letter-spacing:.1em}.text-blue-500{--tw-text-opacity:1;color:rgb(59 130 246/var(--tw-text-opacity,1))}.text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235/var(--tw-text-opacity,1))}.text-emerald-500{--tw-text-opacity:1;color:rgb(16 185 129/var(--tw-text-opacity,1))}.text-emerald-700{--tw-text-opacity:1;color:rgb(4 120 87/var(--tw-text-opacity,1))}.text-indigo-300{--tw-text-opacity:1;color:rgb(165 180 252/var(--tw-text-opacity,1))}.text-indigo-400{--tw-text-opacity:1;color:rgb(129 140 248/var(--tw-text-opacity,1))}.text-indigo-600{--tw-text-opacity:1;color:rgb(79 70 229/var(--tw-text-opacity,1))}.text-indigo-700{--tw-text-opacity:1;color:rgb(67 56 202/var(--tw-text-opacity,1))}.text-red-200{--tw-text-opacity:1;color:rgb(254 202 202/var(--tw-text-opacity,1))}.text-red-300{--tw-text-opacity:1;color:rgb(252 165 165/var(--tw-text-opacity,1))}.text-red-500{--tw-text-opacity:1;color:rgb(239 68 68/var(--tw-text-opacity,1))}.text-red-600{--tw-text-opacity:1;color:rgb(220 38 38/var(--tw-text-opacity,1))}.text-slate-300{--tw-text-opacity:1;color:rgb(203 213 225/var(--tw-text-opacity,1))}.text-slate-400{--tw-text-opacity:1;color:rgb(148 163 184/var(--tw-text-opacity,1))}.text-slate-500{--tw-text-opacity:1;color:rgb(100 116 139/var(--tw-text-opacity,1))}.text-slate-600{--tw-text-opacity:1;color:rgb(71 85 105/var(--tw-text-opacity,1))}.text-slate-700{--tw-text-opacity:1;color:rgb(51 65 85/var(--tw-text-opacity,1))}.text-slate-800{--tw-text-opacity:1;color:rgb(30 41 59/var(--tw-text-opacity,1))}.text-slate-900{--tw-text-opacity:1;color:rgb(15 23 42/var(--tw-text-opacity,1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255/var(--tw-text-opacity,1))}.line-through{text-decoration-line:line-through}.decoration-emerald-500\/50{text-decoration-color:rgba(16,185,129,.5)}.opacity-0{opacity:0}.opacity-50{opacity:.5}.opacity-60{opacity:.6}.opacity-70{opacity:.7}.shadow-2xl{--tw-shadow:0 25px 50px -12px rgba(0,0,0,.25);--tw-shadow-colored:0 25px 50px -12px var(--tw-shadow-color)}.shadow-2xl,.shadow-sm{box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgba(0,0,0,.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color)}.outline-none{outline:2px solid transparent;outline-offset:2px}.grayscale{--tw-grayscale:grayscale(100%)}.grayscale,.grayscale-\[0\.5\]{filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.grayscale-\[0\.5\]{--tw-grayscale:grayscale(0.5)}.filter{filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.backdrop-blur-sm{--tw-backdrop-blur:blur(4px);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.transition{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-colors{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-opacity{transition-property:opacity;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.duration-1000{transition-duration:1s}.hover\:bg-indigo-700:hover{--tw-bg-opacity:1;background-color:rgb(67 56 202/var(--tw-bg-opacity,1))}.hover\:bg-red-100:hover{--tw-bg-opacity:1;background-color:rgb(254 226 226/var(--tw-bg-opacity,1))}.hover\:bg-slate-100:hover{--tw-bg-opacity:1;background-color:rgb(241 245 249/var(--tw-bg-opacity,1))}.hover\:bg-slate-50:hover{--tw-bg-opacity:1;background-color:rgb(248 250 252/var(--tw-bg-opacity,1))}.hover\:text-indigo-600:hover{--tw-text-opacity:1;color:rgb(79 70 229/var(--tw-text-opacity,1))}.hover\:text-indigo-800:hover{--tw-text-opacity:1;color:rgb(55 48 163/var(--tw-text-opacity,1))}.hover\:text-red-500:hover{--tw-text-opacity:1;color:rgb(239 68 68/var(--tw-text-opacity,1))}.focus\:border-indigo-500:focus{--tw-border-opacity:1;border-color:rgb(99 102 241/var(--tw-border-opacity,1))}.focus\:ring-2:focus{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow),var(--tw-ring-shadow),var(--tw-shadow,0 0 #0000)}.focus\:ring-indigo-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(99 102 241/var(--tw-ring-opacity,1))}.group:hover .group-hover\:opacity-100{opacity:1}@media (min-width:768px){.md\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.md\:flex-row{flex-direction:row}.md\:items-end{align-items:flex-end}}@media (min-width:1024px){.lg\:col-span-3{grid-column:span 3/span 3}.lg\:col-span-9{grid-column:span 9/span 9}.lg\:grid-cols-12{grid-template-columns:repeat(12,minmax(0,1fr))}.lg\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.lg\:px-8{padding-left:2rem;padding-right:2rem}}</style>
    <style>
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .card-shadow { box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.1); }
        .ingested-row { opacity: 0.5; filter: grayscale(1); }
        .ingested-text { text-decoration: line-through; color: #94a3b8; }
        input[type="date"]::-webkit-calendar-picker-indicator { cursor: pointer; opacity: 0.6; }

        /* Mobile Modal Hack */
        @media (max-width: 1000px) {
            #bulk-pass-modal > div {
                max-height: 90dvh !important;
                height: 90dvh !important;
            }
        }

        @media (min-width: 768px) {
            .md\:table-cell { display: table-cell !important; }
        }
        @media (min-width: 1280px) {
            .xl\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)) !important; }
        }
        .bg-slate-900 { background-color: rgb(15 23 42) !important; }
    </style>
    <style>

        .system-guide-container {
            width: 100%;
            max-width: 700px;
            background: var(--surface);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .guide-header {
            /* background: var(--primary); */
            color: white;
            padding: 1.5rem;
            text-align: center;
        }
        .guide-header h2 { margin: 0; font-weight: 600; }
        .guide-header p { margin: 0.5rem 0 0; opacity: 0.9; font-size: 0.9rem; }

        /* Timer Section */
        .timer-widget {
            background: #1e293b;
            color: white;
            padding: 1.5rem;
            text-align: center;
        }

        .timer-display {
            font-family: 'Courier New', monospace;
            font-size: 3.5rem;
            font-weight: 700;
            letter-spacing: 2px;
            margin: 0.5rem 0;
            font-variant-numeric: tabular-nums;
        }

        .timer-controls button {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            margin: 0 4px;
        }
        .timer-controls button:hover { background: rgba(255,255,255,0.2); }
        .timer-controls button.active { background: var(--success); border-color: var(--success); color: white; }
        .timer-controls button.reset { color: #fca5a5; border-color: rgba(239,68,68,0.3); }

        .timer-mode-switch {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #94a3b8;
        }
        .mode-btn { cursor: pointer; padding-bottom: 2px; }
        .mode-btn.selected { color: white; border-bottom: 2px solid var(--accent); }

        /* Phases & Steps */
        .phase-divider {
            background: #f1f5f9;
            color: #475569;
            padding: 0.75rem 1.5rem;
            font-size: 0.85rem;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            border-bottom: 1px solid #e2e8f0;
            border-top: 1px solid #e2e8f0;
        }

        .steps-list {
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .step-item {
            border-bottom: 1px solid #e2e8f0;
            padding: 1.25rem 1.5rem;
            transition: background 0.2s;
        }
        .step-item:last-child { border-bottom: none; }
        .step-item:hover { background: #f8fafc; }

        .step-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .step-number {
            /* background: var(--primary); */
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .step-title {
            font-weight: 600;
            color: var(--text);
            font-size: 1rem;
        }

        .step-desc {
            color: var(--text-light);
            font-size: 0.9rem;
            line-height: 1.5;
            margin-left: calc(24px + 1rem);
        }

        .bloom-badge {
            display: inline-block;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 12px;
            background: #e0f2fe;
            color: #0369a1;
            font-weight: 600;
            margin-left: auto;
        }

        .step-check {
            margin-left: calc(24px + 1rem);
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text);
            cursor: pointer;
            opacity: 0.8;
        }
        .step-check:hover { opacity: 1; }
    </style>
    <style>
        /* Some of the classes that Gemini insists exists, but aren't a part of my inlined Tailwind */
        .bg-blue-600 {
            background-color: steelblue;
        }
        mastery-stats, block-controls, app-navigation, priority-sidebar,
        topic-mastery-view, ingestion-checklist-view, lecture-catalog-view,
        pass-history-view, walkthrough-view {
            display: block;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen font-sans">
<div id="app" class="max-w-7xl mx-auto px-4 py-8 lg:px-8">
    <!-- Header & Global Stats -->
    <header class="mb-10">
        <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-8">
            <div>
                <h1 class="text-3xl font-bold text-slate-800 tracking-tight">Mastery Optimization Dashboard</h1>
                <p class="text-slate-500 mt-1">Brown University's Warren Alpert Medical School Learning System</p>
                <div class="mt-6 flex items-center gap-3">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Current Block:</label>
                    <block-controls id="block-controls"></block-controls>
                </div>
            </div>
            <mastery-stats id="mastery-stats"></mastery-stats>
        </div>
        
    </header>

    <!-- Toolbar: Persistence Layer -->
    <div class="mb-6 flex flex-wrap gap-3">
        <button id="export-data-btn" class="bg-white border border-slate-200 px-4 py-2 rounded-xl text-xs font-bold text-slate-600 hover:bg-slate-50 flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
            Export Backup (.json)
        </button>
        <label class="bg-white border border-slate-200 px-4 py-2 rounded-xl text-xs font-bold text-slate-600 hover:bg-slate-50 flex items-center gap-2 cursor-pointer">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
            Restore Backup
            <input type="file" id="import-input-field" class="hidden" accept=".json">
        </label>
        <button id="clear-all-data-btn" class="bg-red-50 border border-red-100 px-4 py-2 rounded-xl text-xs font-bold text-red-600 hover:bg-red-100">
            Clear All Data
        </button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <!-- Sidebar -->
        <aside class="lg:col-span-3 space-y-6">
            <app-navigation id="app-navigation" active-view="dashboard"></app-navigation>
            <priority-sidebar id="priority-sidebar"></priority-sidebar>
        </aside>

        <!-- Main -->
        <main class="lg:col-span-9">
            <topic-mastery-view id="view-dashboard" class="view"></topic-mastery-view>

            <ingestion-checklist-view id="view-checklist" class="view hidden"></ingestion-checklist-view>

            <lecture-catalog-view id="view-lectures" class="view hidden"></lecture-catalog-view>
                

            <pass-history-view id="view-history" class="view hidden"></pass-history-view>
            <!-- Walkthrough -->
            <walkthrough-view id="view-walkthrough" class="view hidden space-y-8"></walkthrough-view>

        </main>
    </div>
</div>

    <!-- Modals -->
    <div id="topic-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-md p-8 shadow-2xl">
            <h3 id="topic-modal-title" class="text-2xl font-bold mb-6 text-slate-800">New Master Topic</h3>
            <form id="add-topic-form" class="space-y-4">
                <input type="hidden" id="topic-edit-id">
                <input type="text" id="topic-name" required class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Topic Name">
                <input type="text" id="topic-subject" class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Subject (e.g. Renal)">
                <input type="text" id="topic-tags" class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Tags (e.g. #high-yield, #step1)">
                <div class="flex gap-3">
                    <button type="button" id="cancel-topic-modal" class="flex-1 py-3 border border-slate-200 rounded-xl font-bold">Cancel</button>
                    <button type="submit" id="topic-submit-btn" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="lecture-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-md p-8 shadow-2xl">
            <h3 id="lecture-modal-title" class="text-2xl font-bold mb-6 text-slate-800">Add Lecture</h3>
            <form id="add-edit-lecture-form" class="space-y-4">
                <input type="hidden" id="lecture-edit-id">
                <input type="text" id="lecture-title" required class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Lecture Title">
                <input type="date" id="lecture-date" required class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500">
                <label class="block text-[10px] font-bold text-slate-400 uppercase px-1">Tag Relevant Topics</label>
                <div id="topic-selector-container" class="max-h40 overflow-y-auto border border-slate-200 rounded-xl p-3 custom-scroll"></div>
                <div class="flex gap-3">
                    <button type="button" id="cancel-lecture-modal" class="flex-1 py-3 border border-slate-200 rounded-xl font-bold">Cancel</button>
                    <button type="submit" id="lecture-submit-btn" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="pass-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-md p-8 shadow-2xl">
            <h3 id="pass-modal-title" class="text-2xl font-bold mb-6 text-slate-800">Log Pass</h3>
            <form id="add-edit-pass-form" class="space-y-4">
                <input type="hidden" id="pass-edit-id">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Target Topic</label>
                    <select id="pass-topic-id" required class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Pass Date</label>
                    <input type="datetime-local" id="pass-date" required class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" step="0.1" min="0" max="10" value="0" id="pass-sp3" required class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Sp3 (0-10)">
                    <input type="number" step="0.1" min="0" max="10" value="0" id="pass-quiz" required class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Quiz (0-10)">
                </div>
                <textarea id="pass-note" rows="3" class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Sprint Notes..."></textarea>
                <div class="flex gap-3 pt-2">
                    <button type="button" id="cancel-pass-modal" class="flex-1 py-3 border border-slate-200 rounded-xl font-bold">Cancel</button>
                    <button type="submit" id="pass-submit-btn" class="flex-1 bg-emerald-600 text-white py-3 rounded-xl font-bold">Log Pass</button>
                </div>
            </form>
        </div>
    </div>

    <div id="goal-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-8 shadow-2xl">
            <h3 class="text-2xl font-bold mb-4 text-slate-800">Set Mastery Goal</h3>
            <p class="text-xs text-slate-500 mb-6 leading-relaxed">Define your target Harmonic Mean (Mh) for this block.</p>
            <form id="set-goal-form" class="space-y-4">
                <input type="number" step="0.1" min="0.1" max="10" id="goal-mh-target" required class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Target Mh (e.g. 7.5)">
                <div class="flex gap-3 pt-2">
                    <button type="button" id="cancel-goal-modal" class="flex-1 py-3 border border-slate-200 rounded-xl font-bold">Cancel</button>
                    <button type="submit" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold">Set Target</button>
                </div>
            </form>
        </div>
    </div>

    <div id="block-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-8 shadow-2xl">
            <h3 class="text-2xl font-bold mb-4 text-slate-800">New Block</h3>
            <p class="text-xs text-slate-500 mb-6 leading-relaxed">Create a new block to organize your topics and lectures.</p>
            <form id="add-block-form" class="space-y-4">
                <input type="text" id="block-name" required class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Block Name (e.g. Neurology)">
                <div class="flex gap-3 pt-2">
                    <button type="button" id="cancel-block-modal" class="flex-1 py-3 border border-slate-200 rounded-xl font-bold">Cancel</button>
                    <button type="submit" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold">Create Block</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Log Modal -->
    <div id="bulk-pass-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-3xl p-6 sm:p-8 shadow-2xl flex flex-col max-h-[85vh] overflow-hidden transition-all">
            <h3 class="text-2xl font-bold mb-4 text-slate-800 flex-shrink-0">Bulk Log Passes</h3>
            
            <!-- Step 1: Select Topics -->
            <div id="bulk-step-1" class="flex-1 flex flex-col min-h-0 overflow-hidden">
                <p class="text-xs text-slate-500 mb-4 flex-shrink-0">Select the topics you studied in this session.</p>
                <div class="flex items-center gap-4 mb-3 p-2 bg-slate-50 rounded-xl border border-slate-100 flex-shrink-0">
                    <label class="flex items-center gap-2 text-sm font-bold text-slate-700 cursor-pointer select-none">
                        <input type="checkbox" id="bulk-select-all" class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300">
                        Select All
                    </label>
                    <div class="h-6 w-px bg-slate-200"></div>
                    <input type="text" id="bulk-search" placeholder="Filter topics..." class="flex-1 px-3 py-1.5 text-sm rounded-lg border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500">
                    <span id="bulk-selection-count" class="text-xs font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-lg border border-indigo-100">0 selected</span>
                </div>
                <!-- Added min-h-0 and overflow-y-auto to this container explicitly -->
                <div id="bulk-topic-list" class="flex-1 overflow-y-auto custom-scroll border border-slate-100 rounded-xl p-2 space-y-1 bg-slate-50/50 min-h-0"></div>
                <div class="flex gap-3 pt-6 mt-auto flex-shrink-0">
                    <button type="button" id="cancel-bulk-modal" class="px-6 py-3 border border-slate-200 rounded-xl font-bold text-slate-600 hover:bg-slate-50 transition-colors">Cancel</button>
                    <button type="button" id="bulk-next-btn" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Next Step</button>
                </div>
            </div>

            <!-- Step 2: Enter Scores -->
            <div id="bulk-step-2" class="hidden flex-1 flex flex-col min-h-0 overflow-hidden">
                <div class="flex gap-4 mb-4 flex-shrink-0">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Pass Date</label>
                        <input type="datetime-local" id="bulk-date" class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
                <!-- Added min-h-0 and overflow-y-auto to this container explicitly -->
                <div class="flex-1 overflow-y-auto custom-scroll border border-slate-100 rounded-xl bg-slate-50/50 min-h-0">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-100 sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="px-4 py-3 text-xs font-bold text-slate-500 uppercase border-b border-slate-200">Topic</th>
                                <th class="px-2 py-3 text-xs font-bold text-slate-500 uppercase w-24 text-center border-b border-slate-200">Sp3 (0-10)</th>
                                <th class="px-2 py-3 text-xs font-bold text-slate-500 uppercase w-24 text-center border-b border-slate-200">Quiz (0-10)</th>
                                <th class="px-2 py-3 text-xs font-bold text-slate-500 uppercase border-b border-slate-200">Note</th>
                            </tr>
                        </thead>
                        <tbody id="bulk-input-list" class="divide-y divide-slate-100 bg-white"></tbody>
                    </table>
                </div>
                <div class="flex gap-3 pt-6 mt-auto flex-shrink-0">
                    <button type="button" id="bulk-back-btn" class="px-6 py-3 border border-slate-200 rounded-xl font-bold text-slate-600 hover:bg-slate-50 transition-colors">Back</button>
                    <button type="button" id="bulk-submit-btn" class="flex-1 bg-emerald-600 text-white py-3 rounded-xl font-bold hover:bg-emerald-700 transition-colors">Save All Passes</button>
                </div>
            </div>
        </div>
    </div>

    <div id="log-lecture-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-md p-8 shadow-2xl">
            <h3 class="text-2xl font-bold mb-6 text-slate-800">Log Lecture</h3>
            <p class="text-xs text-slate-500 mb-4">Log a pass for <strong>all topics</strong> associated with this lecture.</p>
            <form id="log-lecture-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Select Lecture</label>
                    <select id="log-lecture-id" required class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Pass Date</label>
                    <input type="datetime-local" id="log-lecture-date" required class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" step="0.1" min="0" value="0" max="10" id="log-lecture-sp3" required class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Sp3 (0-10)">
                    <input type="number" step="0.1" min="0" value="0" max="10" id="log-lecture-quiz" required class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Quiz (0-10)">
                </div>
                <textarea id="log-lecture-note" rows="3" class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Note (applied to all)..."></textarea>
                <div class="flex gap-3 pt-2">
                    <button type="button" id="cancel-log-lecture-modal" class="flex-1 py-3 border border-slate-200 rounded-xl font-bold">Cancel</button>
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold">Log All</button>
                </div>
            </form>
        </div>
    </div>
        </div>
    </div>
<script>
    // --- Custom Elements ---

    class MasteryStats extends HTMLElement {
        constructor() {
            super();
            this._data = { mh: "0.0", target: "0.0", ingestion: "0 / 0", mastered: "0 / 0" };
        }
        set data(value) {
            this._data = value;
            this.render();
        }
        connectedCallback() { this.render(); }
        render() {
            const mh = parseFloat(this._data.mh);
            const target = parseFloat(this._data.target);
            const showProgress = target > 0;
            const percent = showProgress ? Math.min(100, Math.round((mh / target) * 100)) : 0;

            this.innerHTML = `
                <div class="flex flex-wrap gap-4">
                    <div class="bg-white p-4 rounded-2xl card-shadow border border-slate-100 min-w-[160px] relative group">
                        <p class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Harmonic Mean (Mh)</p>
                        <div class="flex items-baseline gap-2">
                            <p class="text-3xl font-bold text-indigo-600">${this._data.mh}</p>
                            <p class="text-xs font-bold text-slate-300">/ ${this._data.target}</p>
                        </div>
                        <button onclick="openGoalModal()" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-[10px] font-black text-indigo-400 hover:text-indigo-600 uppercase">Set Goal</button>
                    </div>
                    <div class="bg-white p-4 rounded-2xl card-shadow border border-slate-100 min-w-[140px]">
                        <p class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Lecture Coverage</p>
                        <p class="text-3xl font-bold text-blue-500">${this._data.ingestion}</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl card-shadow border border-slate-100 min-w-[140px]">
                        <p class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Topics Mastered</p>
                        <p class="text-3xl font-bold text-emerald-500">${this._data.mastered}</p>
                    </div>
                </div>
                ${showProgress ? `
                <div class="mt-6 bg-white p-5 rounded-2xl card-shadow border border-slate-100">
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-xs font-bold text-slate-500 uppercase tracking-widest">Block Mastery Progress</p>
                        <p class="text-xs font-black text-indigo-600">${percent}%</p>
                    </div>
                    <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden">
                        <div class="bg-indigo-600 h-full transition-all duration-1000" style="width: ${percent}%"></div>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-2 font-medium italic">
                        ${percent >= 100 ? "Goal Met." : `${(target - mh).toFixed(2)} points to go.`}
                    </p>
                </div>
                ` : ''}
            `;
        }
    }
    customElements.define('mastery-stats', MasteryStats);

    class BlockControls extends HTMLElement {
        set data({ blocks, activeBlockId, isAllBlocks }) {
            this._blocks = blocks;
            this._activeBlockId = activeBlockId;
            this._isAllBlocks = isAllBlocks;
            this.render();
        }
        connectedCallback() { this.render(); }
        render() {
            if (!this._blocks) return;
            const options = `<option value="all" ${this._isAllBlocks ? 'selected' : ''}>All Blocks (Longitudinal)</option>` +
                          this._blocks.map(b => `<option value="${b.id}" ${(!this._isAllBlocks && b.id === this._activeBlockId) ? 'selected' : ''}>${b.name}</option>`).join('') +
                          '<option value="new_block_action" class="font-bold text-indigo-600">+ New Block...</option>';

            this.innerHTML = `
                <div class="flex items-center gap-2">
                    <div class="relative min-w-[220px]">
                        <select onchange="handleBlockChange(this.value)" class="w-full bg-white border border-slate-200 pl-4 pr-10 py-2.5 rounded-xl text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-indigo-500 appearance-none shadow-sm">
                            ${options}
                        </select>
                        <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                    <button onclick="openRenameBlock()" class="p-2 text-slate-400 hover:text-indigo-600 hover:bg-slate-100 rounded-lg transition-colors ${this._isAllBlocks ? 'hidden' : ''}" title="Rename Block">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                    </button>
                </div>
            `;
        }
    }
    customElements.define('block-controls', BlockControls);

    class AppNavigation extends HTMLElement {
        static get observedAttributes() { return ['active-view']; }
        attributeChangedCallback() { this.render(); }
        connectedCallback() { this.render(); }
        render() {
            const activeView = this.getAttribute('active-view');
            const navItems = [
                { id: 'dashboard', label: 'Topic Mastery' },
                { id: 'checklist', label: 'Lecture Checklist' },
                { id: 'lectures', label: 'Lecture Catalog' },
                { id: 'history', label: 'Pass History' },
                { id: 'walkthrough', label: 'Walkthrough' }
            ];
            this.innerHTML = `
                <nav class="bg-white rounded-2xl card-shadow border border-slate-100 overflow-hidden">
                    ${navItems.map(item => {
                        const isActive = item.id === activeView;
                        return `
                            <button onclick="switchView('${item.id}')" class="w-full text-left px-6 py-4 font-medium flex items-center gap-3 transition-all ${isActive ? 'bg-indigo-50 text-indigo-700 border-l-4 border-indigo-600' : 'hover:bg-slate-50 text-slate-600'}">
                                ${item.label}
                            </button>
                        `;
                    }).join('')}
                </nav>
            `;
        }
    }
    customElements.define('app-navigation', AppNavigation);

    class PrioritySidebar extends HTMLElement {
        set data(priority) {
            this._priority = priority;
            this.render();
        }
        connectedCallback() { this.render(); }
        render() {
            const content = this._priority ? `
                <div class="bg-white/10 rounded-xl p-3 border border-white/20">
                    <p class="text-[10px] uppercase font-bold text-indigo-200 mb-1">${this._priority.topic.subject || 'General'}</p>
                    <p class="text-sm font-bold text-white mb-2 leading-tight">${this._priority.topic.name}</p>
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-medium text-indigo-200 italic">Mh: ${this._priority.mi.toFixed(1)}</span>
                        <button onclick="openLogPassForTopic('${this._priority.topic.id}')" class="text-[10px] bg-white text-indigo-600 px-2 py-1 rounded font-black uppercase">LOG</button>
                    </div>
                </div>
            ` : '<div class="bg-white/10 rounded-xl p-3 border border-white/20"><span class="text-xs uppercase font-bold opacity-70">Add topics to begin</span></div>';

            this.innerHTML = `
                <div class="bg-indigo-600 rounded-2xl p-6 text-white card-shadow">
                    <h3 class="font-bold text-lg mb-2">Next Priority</h3>
                    ${content}
                </div>
            `;
        }
    }
    customElements.define('priority-sidebar', PrioritySidebar);

    class TopicMasteryView extends HTMLElement {
        static renderRow(topic) {
            const stats = getTopicStats(topic.id);
            const tagHtml = (topic.tags || []).map(tag => `<span class="ml-2 text-[9px] px-1.5 py-0.5 bg-slate-100 text-slate-500 rounded font-mono">${tag}</span>`).join('');
            let colorClass = parseFloat(stats.mi) >= 7 ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-700';
            const badgeHtml = `<span class="px-3 py-1 rounded-full text-xs font-bold ${colorClass}">${stats.mi}</span>`;

            return `<tr>
                <td class="px-6 py-4 font-bold text-slate-800">${topic.name}${tagHtml}</td>
                <td class="text-center hidden md:table-cell">${topic.subject}</td>
                <td class="text-center">${badgeHtml}</td>
                <td class="text-right px-6 space-x-2">
                    <button data-id="${topic.id}" class="edit-topic-btn text-indigo-300 hover:text-indigo-600 transition-colors text-[10px] font-bold uppercase">Edit</button>
                    <button data-id="${topic.id}" class="delete-topic-btn text-slate-300 hover:text-red-500 transition-colors text-lg">Ã—</button>
                </td>
            </tr>`;
        }
        set data({ state, activeTopics, isAllBlocks }) {
            this._state = state;
            this._activeTopics = activeTopics;
            this._isAllBlocks = isAllBlocks;
            this.render();
        }
        connectedCallback() {
            this.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                if (btn.classList.contains('edit-topic-btn')) openEditTopic(btn.dataset.id);
                if (btn.classList.contains('delete-topic-btn')) deleteTopic(btn.dataset.id);
            });
        }
        render() {
            if (!this._state) return;
            let tableRows = '';
            if (this._isAllBlocks) {
                const groupedHtml = this._state.blocks.map(block => {
                    const blockTopics = this._state.topics.filter(t => t.blockId === block.id);
                    if (blockTopics.length === 0) return '';
                    const sorted = blockTopics.sort((a,b) => getTopicStats(a.id).mi - getTopicStats(b.id).mi);
                    return `
                        <tr class="bg-slate-100/80 border-y border-slate-200">
                            <td colspan="4" class="px-6 py-2 text-xs font-bold text-slate-500 uppercase tracking-widest">${block.name}</td>
                        </tr>
                        ${sorted.map(t => TopicMasteryView.renderRow(t)).join('')}
                    `;
                }).join('');

                const orphaned = this._state.topics.filter(t => !this._state.blocks.find(b => b.id === t.blockId));
                let orphanedHtml = '';
                if (orphaned.length > 0) {
                    orphanedHtml = `
                        <tr class="bg-red-50 border-y border-red-100">
                            <td colspan="4" class="px-6 py-2 text-xs font-bold text-red-500 uppercase tracking-widest">Unassigned</td>
                        </tr>` + orphaned.map(t => TopicMasteryView.renderRow(t)).join('');
                }
                tableRows = groupedHtml + orphanedHtml;
            } else {
                tableRows = this._activeTopics.sort((a,b) => getTopicStats(a.id).mi - getTopicStats(b.id).mi).map(t => TopicMasteryView.renderRow(t)).join('');
            }

            if (!tableRows) tableRows = '<tr><td colspan="4" class="px-6 py-10 text-center text-slate-400 italic">No topics found.</td></tr>';

            this.innerHTML = `
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-slate-800">Topic Master List</h2>
                    <button onclick="openAddTopic()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-xl text-sm font-semibold transition-all ${this._isAllBlocks ? 'hidden' : ''}">Add Topic</button>
                </div>
                <div class="bg-white rounded-2xl card-shadow border border-slate-100 overflow-hidden">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-slate-50 border-b border-slate-100">
                                <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider">Topic</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-center hidden md:table-cell">Subject</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-center">Mi</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">${tableRows}</tbody>
                    </table>
                </div>
            `;
        }
    }
    customElements.define('topic-mastery-view', TopicMasteryView);

    class IngestionChecklistView extends HTMLElement {
        set data({ state, lectures }) {
            this._state = state;
            this._lectures = lectures;
            this.render();
        }
        connectedCallback() {
            this.addEventListener('change', (e) => {
                if (e.target.classList.contains('toggle-ingested-check')) toggleIngested(e.target.dataset.id);
            });
        }
        render() {
            if (!this._state) return;
            const tableRows = [...this._lectures].sort((a, b) => new Date(b.date) - new Date(a.date)).map(l => {
                const topicBadges = l.topics.map(tid => {
                    const topic = this._state.topics.find(t => t.id === tid);
                    return topic ? `<span class="bg-indigo-50 text-indigo-600 text-[10px] px-2 py-0.5 rounded mr-1">${topic.name}</span>` : '';
                }).join('');
                return `
                    <tr class="${l.ingested ? 'ingested-row' : ''} transition-all">
                        <td class="px-6 py-4 text-center">
                            <input type="checkbox" ${l.ingested ? 'checked' : ''} data-id="${l.id}" class="toggle-ingested-check w-5 h-5 cursor-pointer text-blue-600 rounded">
                        </td>
                        <td class="px-6 py-4 font-bold text-slate-800 ${l.ingested ? 'ingested-text' : ''}">${l.title}</td>
                        <td class="px-6 py-4">${topicBadges}</td>
                        <td class="px-6 py-4 text-right text-xs text-slate-400 font-mono">${l.date}</td>
                    </tr>
                `;
            }).join('') || '<tr><td colspan="4" class="px-6 py-10 text-center text-slate-400 italic">No lectures found.</td></tr>';
            this.innerHTML = `
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-slate-800">Ingestion Checklist</h2>
                    <p class="text-xs text-slate-400 italic">"Table stakes" documentation of lecture ingestion.</p>
                </div>
                <div class="bg-white rounded-2xl card-shadow border border-slate-100 overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase w-12 text-center">Status</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase">Lecture</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase">Related Master Topics</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase text-right">Date</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">${tableRows}</tbody>
                    </table>
                </div>
            `;
        }
    }
    customElements.define('ingestion-checklist-view', IngestionChecklistView);

    class LectureCatalogView extends HTMLElement {
        static renderCard(lecture, state) {
            return `
                <div class="bg-white p-4 rounded-2xl border border-slate-100 card-shadow relative group ${lecture.ingested ? 'opacity-60 grayscale-[0.5]' : ''}">
                    <div class="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button data-id="${lecture.id}" class="edit-lecture-btn text-indigo-400 hover:text-indigo-600 text-[10px] font-bold">EDIT</button>
                        <button data-id="${lecture.id}" class="delete-lecture-btn text-red-300 hover:text-red-500">Ã—</button>
                    </div>
                    <div class="flex items-start gap-2 pr-12">
                        ${lecture.ingested ? '<span class="text-emerald-500 font-bold text-lg">âœ“</span>' : ''}
                        <div>
                            <p class="font-bold text-slate-800 ${lecture.ingested ? 'line-through decoration-emerald-500/50' : ''}">${lecture.title}</p>
                            <p class="text-[10px] text-slate-400 font-bold uppercase">${lecture.date}</p>
                        </div>
                    </div>
                    <div class="mt-3 flex flex-wrap gap-1">${lecture.topics.map(tid => {
                        const t = state.topics.find(t => t.id === tid);
                        return t ? `<span class="bg-indigo-50 text-indigo-600 text-[9px] px-1.5 py-0.5 rounded font-bold">${t.name}</span>` : '';
                    }).join('')}</div>
                </div>
            `;
        }
        set data({ state, lectures, activeTopics, isAllBlocks }) {
            this._state = state;
            this._lectures = lectures;
            this._activeTopics = activeTopics;
            this._isAllBlocks = isAllBlocks;
            this.render();
        }
        connectedCallback() {
            this.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                if (btn.classList.contains('edit-lecture-btn')) openEditLecture(btn.dataset.id);
                if (btn.classList.contains('delete-lecture-btn')) deleteLecture(btn.dataset.id);
            });
            this.addEventListener('input', (e) => {
                if (e.target.id === 'lecture-search' || e.target.id === 'lecture-sort' || e.target.id === 'lecture-topic-filter') {
                    this.renderGrid();
                }
            });
        }
        render() {
            if (!this._state) return;
            const topicOptions = '<option value="all">All Topics</option>' +
                               (this._activeTopics || []).map(t => `<option value="${t.id}">${t.name}</option>`).join('');

            this.innerHTML = `
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold">Lecture Catalog</h2>
                    <button onclick="openAddLecture()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-sm font-semibold ${this._isAllBlocks ? 'hidden' : ''}">Add Lecture</button>
                </div>
                <div class="bg-white p-4 rounded-2xl card-shadow border border-slate-100 flex flex-wrap gap-4 items-end">
                    <div class="flex-1 min-w-[200px]">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Search Lectures</label>
                        <input type="text" id="lecture-search" placeholder="Search title or topics..." class="w-full px-3 py-2 text-sm rounded-lg border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Sort</label>
                        <select id="lecture-sort" class="w-full bg-slate-50 border border-slate-200 p-2 rounded-lg text-sm">
                            <option value="date-desc">Date (Newest)</option>
                            <option value="date-asc">Date (Oldest)</option>
                            <option value="title-asc">Title (A-Z)</option>
                        </select>
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Filter Topic</label>
                        <select id="lecture-topic-filter" class="w-full bg-slate-50 border border-slate-200 p-2 rounded-lg text-sm">
                            ${topicOptions}
                        </select>
                    </div>
                    <button onclick="resetLectureFilters()" class="px-4 py-2 text-xs font-bold text-slate-400 hover:text-slate-600 transition-colors uppercase">Reset</button>
                </div>
                <div id="lecture-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
            `;
            this.renderGrid();
        }
        renderGrid() {
            const grid = this.querySelector('#lecture-list');
            if (!grid) return;
            const search = this.querySelector('#lecture-search').value.toLowerCase();
            const sort = this.querySelector('#lecture-sort').value;
            const topicFilter = this.querySelector('#lecture-topic-filter').value;

            let filtered = this._lectures.filter(l => {
                const matchesSearch = l.title.toLowerCase().includes(search) ||
                                    l.topics.some(tid => this._state.topics.find(t => t.id === tid)?.name.toLowerCase().includes(search));
                const matchesTopic = topicFilter === 'all' || l.topics.includes(topicFilter);
                return matchesSearch && matchesTopic;
            });

            filtered.sort((a, b) => {
                if (sort === 'date-desc') return new Date(b.date) - new Date(a.date);
                if (sort === 'date-asc') return new Date(a.date) - new Date(b.date);
                return a.title.localeCompare(b.title);
            });

            grid.innerHTML = filtered.map(l => LectureCatalogView.renderCard(l, this._state)).join('') ||
                '<p class="text-slate-400 text-center col-span-full py-10 italic">No matching lectures found.</p>';
        }
    }
    customElements.define('lecture-catalog-view', LectureCatalogView);

    class PassHistoryView extends HTMLElement {
        static renderRow(pass, topicName) {
            const mi = ((0.7 * pass.sp3) + (0.3 * pass.quiz)).toFixed(1);
            return `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-6 py-3 text-xs text-slate-500 whitespace-nowrap">${pass.date}</td>
                    <td class="px-6 py-3 text-xs font-bold text-slate-800">${topicName}</td>
                    <td class="text-center text-xs font-medium whitespace-nowrap">${pass.sp3} / ${pass.quiz}</td>
                    <td class="text-center text-xs font-bold text-indigo-600">${mi}</td>
                    <td class="px-6 py-3 text-[11px] text-slate-500 max-w-xs italic break-words">${pass.note || 'â€”'}</td>
                    <td class="text-right px-6 space-x-2 whitespace-nowrap">
                        <button data-id="${pass.id}" class="edit-pass-btn text-indigo-300 hover:text-indigo-600 text-[10px] font-bold uppercase">Edit</button>
                        <button data-id="${pass.id}" class="delete-pass-btn text-red-200 hover:text-red-500 text-[10px] font-bold uppercase">Del</button>
                    </td>
                </tr>
            `;
        }
        set data({ state, activeTopics, isAllBlocks }) {
            this._state = state;
            this._activeTopics = activeTopics;
            this._isAllBlocks = isAllBlocks;
            this.render();
        }
        connectedCallback() {
            this.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                if (btn.classList.contains('edit-pass-btn')) openEditPass(btn.dataset.id);
                if (btn.classList.contains('delete-pass-btn')) deletePass(btn.dataset.id);
            });
        }
        render() {
            if (!this._state) return;
            const activeTopicIds = new Set(this._activeTopics.map(t => t.id));
            const activePasses = this._state.passes.filter(p => activeTopicIds.has(p.topicId));
            const tableRows = activePasses.sort((a, b) => new Date(b.date) - new Date(a.date)).map(p => {
                const topic = this._state.topics.find(t => t.id === p.topicId);
                return PassHistoryView.renderRow(p, topic ? topic.name : 'Unknown');
            }).join('') || '<tr><td colspan="6" class="px-6 py-10 text-center text-slate-400 italic">No history available.</td></tr>';
            this.innerHTML = `
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold">Pass History</h2>
                    <div class="flex gap-2 ${this._isAllBlocks ? 'hidden' : ''}">
                        <button onclick="openBulkLog()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-xl text-sm font-semibold transition-all">Bulk Log</button>
                        <button onclick="openLogLecture()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-sm font-semibold transition-all">Log Lecture</button>
                        <button onclick="openLogPass()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-xl text-sm font-semibold transition-all">Log New Pass</button>
                    </div>
                </div>
                <div class="bg-white rounded-2xl card-shadow border border-slate-100 overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase">Date</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase">Topic</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase text-center">Sp3/Quiz</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase text-center">Mi</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase">Notes</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">${tableRows}</tbody>
                    </table>
                </div>
            `;
        }
    }
    customElements.define('pass-history-view', PassHistoryView);

    class WalkthroughView extends HTMLElement {
        static get template() {
            return `
                <div class="max-w-4xl mx-auto pb-20">
                    <div class="bg-indigo-600 rounded-3xl p-8 text-white card-shadow mb-8 text-center relative overflow-hidden">
                        <div class="relative z-10">
                            <h2 class="text-3xl font-black mb-2">The Learning System</h2>
                            <p class="text-indigo-100 font-medium">From First Principles to High-Yield Synthesis</p>
                        </div>
                        <div class="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 bg-white/10 rounded-full"></div>
                    </div>

                    <!-- Timer Widget -->
                    <div class="bg-slate-900 rounded-3xl p-8 text-white card-shadow mb-12 text-center">
                        <div class="timer-mode-switch flex justify-center gap-6 mb-6">
                            <span class="mode-btn selected text-xs font-bold tracking-widest uppercase cursor-pointer pb-1 border-b-2 border-transparent transition-all" onclick="setTimerMode('stopwatch')">Stopwatch</span>
                            <span class="mode-btn text-xs font-bold tracking-widest uppercase cursor-pointer pb-1 border-b-2 border-transparent transition-all" onclick="setTimerMode('pomodoro')">Pomodoro (25m)</span>
                            <span class="mode-btn text-xs font-bold tracking-widest uppercase cursor-pointer pb-1 border-b-2 border-transparent transition-all" onclick="setTimerMode('sprint')">Mastery Sprint (60m)</span>
                        </div>
                        <div class="timer-display font-mono text-6xl font-bold mb-8 tabular-nums tracking-tighter" id="timerDisplay">00:00</div>
                        <div class="flex justify-center gap-4">
                            <button id="btnStart" onclick="toggleTimer()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-xl font-bold transition-all min-w-[140px]">Start Focus</button>
                            <button onclick="resetTimer()" class="bg-white/10 hover:bg-white/20 text-red-300 px-8 py-3 rounded-xl font-bold transition-all">Reset</button>
                        </div>
                    </div>

                    <div class="space-y-16">
                        <!-- Mathematical Foundation -->
                        <section>
                            <h3 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] mb-6 pb-2 border-b border-slate-100">The Mathematical Foundation</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-white rounded-2xl p-6 border border-slate-100 card-shadow">
                                    <h4 class="font-bold text-slate-800 text-lg mb-2">Mastery Optimization (MOF)</h4>
                                    <p class="text-slate-600 text-sm mb-4">Objective: Maximize the <b>Harmonic Mean (Mh)</b> of your topic mastery scores. Unlike the average, Mh is punitively sensitive to low values, forcing you to address your weakest topics first.</p>
                                    <code class="block bg-slate-50 p-3 rounded-lg text-xs font-mono text-indigo-600">Mh = T / Î£(1/Mi)</code>
                                </div>
                                <div class="bg-white rounded-2xl p-6 border border-slate-100 card-shadow">
                                    <h4 class="font-bold text-slate-800 text-lg mb-2">Completion Velocity (CCV)</h4>
                                    <p class="text-slate-600 text-sm mb-4">Objective: Measure how efficiently you move topics past the <b>D-Min (Mastery Threshold of 7.0)</b>. If velocity is low, debug your learning process.</p>
                                    <code class="block bg-slate-50 p-3 rounded-lg text-xs font-mono text-indigo-600">Vc = T_Mastered / Total_Time</code>
                                </div>
                            </div>
                        </section>

                        <!-- Phase 1 -->
                        <section>
                            <h3 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] mb-6 pb-2 border-b border-slate-100">Phase 1: Concept Deconstruction</h3>

                            <div class="space-y-8">
                                <div class="bg-white rounded-2xl p-6 border border-slate-100 card-shadow">
                                    <div class="flex justify-between items-start mb-4">
                                        <div class="flex gap-4">
                                            <span class="w-8 h-8 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center font-black">1</span>
                                            <div>
                                                <h4 class="font-bold text-slate-800 text-lg">Scope & Definition</h4>
                                                <p class="text-slate-600 text-sm mt-1">Select a high-yield topic. Define the boundaries: What is this *not*? Identify the "First Principles" mechanism driving the pathology.</p>
                                            </div>
                                        </div>
                                        <span class="px-2 py-1 rounded bg-blue-50 text-blue-600 text-[10px] font-black uppercase">Understand</span>
                                    </div>
                                </div>

                                <div class="bg-white rounded-2xl p-6 border border-slate-100 card-shadow">
                                    <div class="flex justify-between items-start mb-4">
                                        <div class="flex gap-4">
                                            <span class="w-8 h-8 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center font-black">2</span>
                                            <div>
                                                <h4 class="font-bold text-slate-800 text-lg">Mechanism Mapping</h4>
                                                <p class="text-slate-600 text-sm mt-1">Sketch the physiological pathway. Identify the exact break point in the chain. <i>If you can't draw the mechanism, you cannot write the question.</i></p>
                                                <div class="mt-4 flex items-center gap-2">
                                                    <input type="checkbox" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                                                    <span class="text-xs text-slate-500 font-medium">Can I explain the "Why" simply?</span>
                                                </div>
                                            </div>
                                        </div>
                                        <span class="px-2 py-1 rounded bg-indigo-50 text-indigo-600 text-[10px] font-black uppercase">Analyze</span>
                                    </div>
                                </div>

                                <div class="bg-slate-50 rounded-2xl p-6 border border-slate-200">
                                    <div class="flex justify-between items-start mb-6">
                                        <div class="flex gap-4">
                                            <span class="w-8 h-8 rounded-lg bg-white text-slate-400 flex items-center justify-center font-black">2a</span>
                                            <div>
                                                <h4 class="font-bold text-slate-800 text-lg">In-depth</h4>
                                                <p class="text-slate-500 text-sm mt-1">Sketch the physiological pathway. Identify the exact break point in the chain.</p>
                                            </div>
                                        </div>
                                        <span class="px-2 py-1 rounded bg-slate-200 text-slate-600 text-[10px] font-black uppercase">Details</span>
                                    </div>

                                    <div class="overflow-x-auto">
                                        <table class="w-full text-left text-xs border-collapse">
                                            <thead>
                                                <tr class="text-slate-400 uppercase tracking-wider border-b border-slate-200">
                                                    <th class="py-2 pr-4 font-black">Pass</th>
                                                    <th class="py-2 px-4 font-black">Time</th>
                                                    <th class="py-2 px-4 font-black">Activity</th>
                                                    <th class="py-2 pl-4 font-black">Cognitive Goal</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-slate-200 text-slate-600">
                                                <tr>
                                                    <td class="py-3 pr-4 font-bold text-slate-800">0</td>
                                                    <td class="py-3 px-4 font-medium">3m</td>
                                                    <td class="py-3 px-4"><b>Priming (Pass 0)</b><br>Use the <b>Blur Test</b> (squint to see form over content) or <b>Architect's Blueprint</b> (Outline from memory after 90s scan).</td>
                                                    <td class="py-3 pl-4"><b>Orientation:</b> Force a structural overview. Prevent detail fixation.</td>
                                                </tr>
                                                <tr>
                                                    <td class="py-3 pr-4 font-bold text-slate-800">1</td>
                                                    <td class="py-3 px-4 font-medium">12m</td>
                                                    <td class="py-3 px-4"><b>Foundational Mapping</b><br>Create a linear flowchart of the core mechanism or symptom correlations.</td>
                                                    <td class="py-3 pl-4"><b>Structure:</b> Build the skeleton. Ignore nuance.</td>
                                                </tr>
                                                <tr>
                                                    <td class="py-3 pr-4 font-bold text-slate-800">2</td>
                                                    <td class="py-3 px-4 font-medium">25m</td>
                                                    <td class="py-3 px-4"><b>System Stress-Test</b><br>"Deep Dive." Ask "What if?" Break the system. Compare/Contrast with similar diseases.</td>
                                                    <td class="py-3 pl-4"><b>Elaboration:</b> Connect nodes. Deep encoding.</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <p class="mt-6 text-[11px] text-slate-400 italic font-medium">If you can't draw the mechanism, you cannot write the question. (Phase 2)</p>
                                    <div class="mt-2 flex items-center gap-2">
                                        <input type="checkbox" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                                        <span class="text-xs text-slate-500 font-medium">Can I explain the "Why" simply?</span>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Phase 2 -->
                        <section>
                            <h3 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] mb-6 pb-2 border-b border-slate-100">Phase 2: Vignette Construction</h3>

                            <div class="space-y-8">
                                <div class="bg-white rounded-2xl p-6 border border-slate-100 card-shadow">
                                    <div class="flex justify-between items-start mb-4">
                                        <div class="flex gap-4">
                                            <span class="w-8 h-8 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center font-black">3</span>
                                            <div>
                                                <h4 class="font-bold text-slate-800 text-lg">The NBME Vignette</h4>
                                                <p class="text-slate-600 text-sm mt-1">Draft the patient story. Use <b>Demographics, Duration, & Dynamics</b> (symptoms). Avoid buzzwords; describe the finding (e.g., "staccato cough" instead of "pertussis").</p>
                                            </div>
                                        </div>
                                        <span class="px-2 py-1 rounded bg-emerald-50 text-emerald-600 text-[10px] font-black uppercase">Synthesize</span>
                                    </div>
                                </div>

                                <div class="bg-slate-50 rounded-2xl p-6 border border-slate-200">
                                    <div class="flex justify-between items-start mb-6">
                                        <div class="flex gap-4">
                                            <span class="w-8 h-8 rounded-lg bg-white text-slate-400 flex items-center justify-center font-black">3a</span>
                                            <div>
                                                <h4 class="font-bold text-slate-800 text-lg">Vignette In-depth</h4>
                                                <p class="text-slate-500 text-sm mt-1">Lets make a good vignette</p>
                                            </div>
                                        </div>
                                        <span class="px-2 py-1 rounded bg-slate-200 text-slate-600 text-[10px] font-black uppercase">Details</span>
                                    </div>

                                    <div class="overflow-x-auto">
                                        <table class="w-full text-left text-xs border-collapse">
                                            <thead>
                                                <tr class="text-slate-400 uppercase tracking-wider border-b border-slate-200">
                                                    <th class="py-2 pr-4 font-black">Pass</th>
                                                    <th class="py-2 px-4 font-black">Time</th>
                                                    <th class="py-2 px-4 font-black">Activity</th>
                                                    <th class="py-2 pl-4 font-black">Cognitive Goal</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-slate-200 text-slate-600">
                                                <tr>
                                                    <td class="py-3 pr-4 font-bold text-slate-800">3</td>
                                                    <td class="py-3 px-4 font-medium">15m</td>
                                                    <td class="py-3 px-4"><b>Synthesis (Pass 3)</b><br>Generate a complete Clinical Vignette from a single molecular defect. Predict labs, signs, and treatment.</td>
                                                    <td class="py-3 pl-4"><b>Assessment:</b> Determine your Mi score. If you can't synthesize, Mi < 7.</td>
                                                </tr>
                                                <tr>
                                                    <td class="py-3 pr-4 font-bold text-slate-800">Post</td>
                                                    <td class="py-3 px-4 font-medium">5m</td>
                                                    <td class="py-3 px-4"><b>Self-Correction</b><br>Metacognition: Where did the explanation fall apart? Assign confience-based score.</td>
                                                    <td class="py-3 pl-4"><b>Strategy:</b> Feed data back into MOF to choose the next topic.</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-6 flex items-center gap-2">
                                        <input type="checkbox" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                                        <span class="text-xs text-slate-500 font-medium">Can I explain the "Why not"? (The Distractor Logic)</span>
                                    </div>
                                </div>

                                <div class="bg-white rounded-2xl p-6 border border-slate-100 card-shadow">
                                    <div class="flex justify-between items-start mb-4">
                                        <div class="flex gap-4">
                                            <span class="w-8 h-8 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center font-black">4</span>
                                            <div>
                                                <h4 class="font-bold text-slate-800 text-lg">Distractor Logic</h4>
                                                <p class="text-slate-600 text-sm mt-1">Generate 4 wrong answers. Each must be the correct answer for a <i>different</i> disease in the differential.</p>
                                                <div class="mt-4 flex items-center gap-2">
                                                    <input type="checkbox" class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                                                    <span class="text-xs text-slate-500 font-medium">Are distractors distinct pathologies?</span>
                                                </div>
                                            </div>
                                        </div>
                                        <span class="px-2 py-1 rounded bg-amber-50 text-amber-600 text-[10px] font-black uppercase">Evaluate</span>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Phase 3 -->
                        <section>
                            <h3 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] mb-6 pb-2 border-b border-slate-100">Phase 3: Taxonomy Audit</h3>

                            <div class="space-y-8">
                                <div class="bg-white rounded-2xl p-6 border border-slate-100 card-shadow">
                                    <div class="flex justify-between items-start mb-4">
                                        <div class="flex gap-4">
                                            <span class="w-8 h-8 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center font-black">5</span>
                                            <div>
                                                <h4 class="font-bold text-slate-800 text-lg">The "Two-Step" Check</h4>
                                                <p class="text-slate-600 text-sm mt-1">Does the question require identifying the diagnosis first, then answering a secondary question (e.g., side effect of the treatment)?</p>
                                            </div>
                                        </div>
                                        <span class="px-2 py-1 rounded bg-indigo-50 text-indigo-600 text-[10px] font-black uppercase">Analyze</span>
                                    </div>
                                </div>

                                <div class="bg-slate-50 rounded-2xl p-6 border border-slate-200">
                                    <div class="flex justify-between items-start mb-6">
                                        <div class="flex gap-4">
                                            <span class="w-8 h-8 rounded-lg bg-white text-slate-400 flex items-center justify-center font-black">5a</span>
                                            <div>
                                                <h4 class="font-bold text-slate-800 text-lg">Expert Calibration</h4>
                                            </div>
                                        </div>
                                        <span class="px-2 py-1 rounded bg-slate-200 text-slate-600 text-[10px] font-black uppercase">Details</span>
                                    </div>

                                    <div class="overflow-x-auto">
                                        <table class="w-full text-left text-xs border-collapse">
                                            <thead>
                                                <tr class="text-slate-400 uppercase tracking-wider border-b border-slate-200">
                                                    <th class="py-2 pr-4 font-black">Pass</th>
                                                    <th class="py-2 px-4 font-black">Time</th>
                                                    <th class="py-2 px-4 font-black">Activity</th>
                                                    <th class="py-2 pl-4 font-black">Cognitive Goal</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-slate-200 text-slate-600">
                                                <tr>
                                                    <td class="py-3 pr-4 font-bold text-slate-800">4</td>
                                                    <td class="py-3 px-4 font-medium">10m</td>
                                                    <td class="py-3 px-4"><b>Calibration (Discriminative)</b><br>Do <b>3-5 High-Yield Questions</b> (USMLE-Rx/Lecturio). <i>Optional:</i> AI Audit of Vignette.</td>
                                                    <td class="py-3 pl-4"><b>Reality Check:</b> Detect "Illusion of Competence." "Sentinel" check for major flaws.</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <p class="mt-6 text-sm text-slate-500 font-medium italic">"You need to make sure that you're able to answer questions about what you think you know, no matter what the order of complexity."</p>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            `;
        }
        connectedCallback() { this.render(); }
        render() { this.innerHTML = WalkthroughView.template; }
    }
    customElements.define('walkthrough-view', WalkthroughView);

    let state = { blocks: [], activeBlockId: null, topics: [], lectures: [], passes: [], activeViewId: 'dashboard' };

    function init() {
        const saved = localStorage.getItem('med_mastery_v2');
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                // Ensure activeViewId exists
                if (!parsed.activeViewId) parsed.activeViewId = 'dashboard';

                // MIGRATION: v1 -> v2 (Block Architecture)
                if (!parsed.blocks || parsed.blocks.length === 0) {
                    console.log("Migrating to Block Architecture...");
                    const defaultBlockId = 'b-' + Date.now();
                    state = {
                        blocks: [{ 
                            id: defaultBlockId, 
                            name: "Core Block", 
                            masteryGoal: parsed.masteryGoal || 0 
                        }],
                        activeBlockId: defaultBlockId,
                        activeViewId: 'dashboard',
                        topics: (parsed.topics || []).map(t => ({ ...t, blockId: defaultBlockId })),
                        lectures: (parsed.lectures || []).map(l => ({ ...l, blockId: defaultBlockId, ingested: l.ingested ?? false })),
                        passes: parsed.passes || []
                    };
                    save();
                } else {
                    state = parsed;
                }
            } catch (e) { 
                console.error("Storage corruption detected. Resetting.", e);
                resetState();
            }
        } else {
            resetState();
        }
        
        // Render immediately, then setup listeners
        render();
        setupEventListeners();
    }

    function resetState() {
        const defaultBlockId = 'b-' + Date.now();
        state = {
            blocks: [{ id: defaultBlockId, name: "Block 1", masteryGoal: 0 }],
            activeBlockId: defaultBlockId,
            activeViewId: 'dashboard',
            topics: [],
            lectures: [],
            passes: []
        };
        save();
        render();
    }

    function save() {
        localStorage.setItem('med_mastery_v2', JSON.stringify(state));
        render();
    }

    function getActiveBlock() {
        return state.blocks.find(b => b.id === state.activeBlockId) || state.blocks[0];
    }

    // --- Data Operations ---

    function exportData() {
        const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Mastery_Backup_${new Date().toISOString()}.json`;
        a.click();
    }

    function importData(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const parsed = JSON.parse(event.target.result);
                // Basic validation
                if (!parsed.blocks && !parsed.topics) throw new Error("Invalid Format");
                
                // Re-run migration logic if importing old format
                if (!parsed.blocks) {
                    const defaultBlockId = 'b-' + Date.now();
                    state = {
                        blocks: [{ id: defaultBlockId, name: "Imported Block", masteryGoal: parsed.masteryGoal || 0 }],
                        activeBlockId: defaultBlockId,
                        topics: (parsed.topics || []).map(t => ({ ...t, blockId: defaultBlockId })),
                        lectures: (parsed.lectures || []).map(l => ({ ...l, blockId: defaultBlockId })),
                        passes: parsed.passes || []
                    };
                } else {
                    state = parsed;
                }
                save();
            } catch (err) { alert("Invalid or incompatible JSON file."); }
        };
        reader.readAsText(file);
    }

    function clearAllData() {
        if(confirm("DANGER: This will permanently delete all your topics, lectures, and history. Proceed?")) {
            resetState();
        }
    }

    // --- UI Helpers ---
    function toggleIngested(lectureId) {
        const lecture = state.lectures.find(l => l.id === lectureId);
        if (lecture) {
            lecture.ingested = !lecture.ingested;
            save();
        render();
        }
    }

    function getFormattedDatetimeNow() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        const formatted = now.toISOString().slice(0, 16); // getting rid of seconds and milliseconds
        return formatted;
    }
    function toggleModal(id) {
        const el = document.getElementById(id);
        if (!el) return;
        
        const willShow = el.classList.contains('hidden');
        el.classList.toggle('hidden');
        
        if (willShow) {
            // Initialization logic when OPENING
            if (id === 'topic-modal') {
                const editId = document.getElementById('topic-edit-id').value;
                if (!editId) {
                    document.getElementById('topic-modal-title').innerText = "New Master Topic";
                    document.getElementById('topic-submit-btn').innerText = "Save";
                }
            }
            if (id === 'lecture-modal') {
                const editId = document.getElementById('lecture-edit-id').value;
                if (!editId) {
                    document.getElementById('lecture-modal-title').innerText = "Add Lecture";
                    document.getElementById('lecture-submit-btn').innerText = "Save Lecture";
                    document.getElementById('lecture-date').value = new Date().toISOString().split('T')[0];
                    populateTopicSelectors(); 
                }
            }
            if (id === 'pass-modal') {
                const editId = document.getElementById('pass-edit-id').value;
                if (!editId) {
                    document.getElementById('pass-modal-title').innerText = "Log Pass";
                    document.getElementById('pass-submit-btn').innerText = "Log Pass";
                    document.getElementById('pass-date').value = getFormattedDatetimeNow();
                    populatePassTopicDropdown();
                }
            }
            if (id === 'goal-modal') {
                const block = getActiveBlock();
                document.getElementById('goal-mh-target').value = block.masteryGoal || "";
            }
            if (id === 'log-lecture-modal') {
                document.getElementById('log-lecture-date').value = getFormattedDatetimeNow();
                populateLogLectureDropdown();
            }
        } else {
            // Cleanup logic when CLOSING
            const form = el.querySelector('form');
            if (form) form.reset();
            const hiddenIds = el.querySelectorAll('input[type="hidden"]');
            hiddenIds.forEach(hi => hi.value = "");
        }
    }

    function openAddTopic() {
        toggleModal('topic-modal');
    }

    function openEditTopic(id) {
        const topic = state.topics.find(t => t.id === id);
        if (!topic) return;
        document.getElementById('topic-edit-id').value = topic.id;
        document.getElementById('topic-modal-title').innerText = "Edit Topic";
        document.getElementById('topic-submit-btn').innerText = "Save Changes";
        document.getElementById('topic-name').value = topic.name;
        document.getElementById('topic-subject').value = topic.subject;
        document.getElementById('topic-tags').value = (topic.tags || []).join(', ');
        toggleModal('topic-modal');
    }

    function deleteTopic(id) { 
        if(confirm("Delete topic and its history?")) { 
            state.topics = state.topics.filter(t => t.id !== id); 
            state.passes = state.passes.filter(p => p.topicId !== id); 
            save();
        render();
        }
    }

    function openAddLecture() {
        toggleModal('lecture-modal');
    }

    function openEditLecture(id) {
        const l = state.lectures.find(x => x.id === id);
        if(!l) return;
        document.getElementById('lecture-edit-id').value = l.id;
        document.getElementById('lecture-modal-title').innerText = "Edit Lecture";
        document.getElementById('lecture-submit-btn').innerText = "Save Changes";
        document.getElementById('lecture-title').value = l.title;
        document.getElementById('lecture-date').value = l.date;
        populateTopicSelectors();
        toggleModal('lecture-modal');
        setTimeout(() => {
            document.querySelectorAll('.topic-check').forEach(cb => { cb.checked = l.topics.includes(cb.value); });
        }, 10);
    }

    function deleteLecture(id) { 
        if(confirm("Delete lecture?")) { 
            state.lectures = state.lectures.filter(l => l.id !== id); 
            save();
        render();
        } 
    }

    function openLogPass() {
        populatePassTopicDropdown();
        toggleModal('pass-modal');
    }

    function openLogPassForTopic(topicId) {
        populatePassTopicDropdown();
        document.getElementById('pass-topic-id').value = topicId;
        toggleModal('pass-modal');
    }

    function openEditPass(id) {
        const p = state.passes.find(x => x.id === id);
        if(!p) return;
        document.getElementById('pass-edit-id').value = p.id;
        document.getElementById('pass-modal-title').innerText = "Edit Pass";
        document.getElementById('pass-submit-btn').innerText = "Save Changes";
        populatePassTopicDropdown();
        setTimeout(() => {
            document.getElementById('pass-topic-id').value = p.topicId;
        }, 0);
        document.getElementById('pass-date').value = p.date;
        document.getElementById('pass-sp3').value = p.sp3;
        document.getElementById('pass-quiz').value = p.quiz;
        document.getElementById('pass-note').value = p.note || "";
        toggleModal('pass-modal');
    }

    function deletePass(id) { 
        if(confirm("Permanently delete this pass?")) { 
            state.passes = state.passes.filter(p => p.id !== id); 
            save();
        render();
        } 
    }

    function openSetGoal() {
        toggleModal('goal-modal');
    }

    function openAddBlock() {
        toggleModal('block-modal');
    }

    function openLogLecture() {
        toggleModal('log-lecture-modal');
    }

    function populateLogLectureDropdown() {
        const isAll = state.activeBlockId === 'all';
        const lectures = isAll ? state.lectures : state.lectures.filter(l => l.blockId === state.activeBlockId);

        // Sort by date desc
        lectures.sort((a,b) => new Date(b.date) - new Date(a.date));

        const el = document.getElementById('log-lecture-id');
        if (lectures.length === 0) {
            el.innerHTML = '<option value="" disabled selected>No lectures found</option>';
        } else {
            el.innerHTML = lectures.map(l => `<option value="${l.id}">${l.title} (${l.date})</option>`).join('');
        }
    }

    function handleLogLectureSubmit(e) {
        e.preventDefault();
        const lectureId = document.getElementById('log-lecture-id').value;
        const date = document.getElementById('log-lecture-date').value;
        const sp3 = parseFloat(document.getElementById('log-lecture-sp3').value);
        const quiz = parseFloat(document.getElementById('log-lecture-quiz').value);
        const note = document.getElementById('log-lecture-note').value;

        if (!lectureId) {
            alert("Please select a lecture.");
            return;
        }

        const lecture = state.lectures.find(l => l.id === lectureId);
        if (!lecture) return;

        if (lecture.topics.length === 0) {
            alert("This lecture has no topics associated with it.");
            return;
        }

        let count = 0;
        lecture.topics.forEach(topicId => {
            state.passes.push({
                id: 'p' + Date.now() + Math.random().toString(36).substr(2, 5),
                topicId: topicId,
                sp3: sp3,
                quiz: quiz,
                date: date,
                note: note ? `[${lecture.title}] ${note}` : `[${lecture.title}]`
            });
            count++;
        });

        toggleModal('log-lecture-modal');
        save();
        render();
    }

    // --- Bulk Log Logic ---
    let bulkSelected = new Set();

    function openBulkLog() {
        bulkSelected.clear();
        document.getElementById('bulk-select-all').checked = false;
        document.getElementById('bulk-search').value = '';
        document.getElementById('bulk-date').value = new Date().toISOString().split('T')[0];
        
        renderBulkTopicList();
        
        // Show Step 1, Hide Step 2
        document.getElementById('bulk-step-1').classList.remove('hidden');
        document.getElementById('bulk-step-2').classList.add('hidden');
        
        // Toggle Modal
        const el = document.getElementById('bulk-pass-modal');
        el.classList.remove('hidden');
    }

    function renderBulkTopicList() {
        const isAll = state.activeBlockId === 'all';
        let topics = isAll ? state.topics : state.topics.filter(t => t.blockId === state.activeBlockId);
        
        const search = document.getElementById('bulk-search').value.toLowerCase();
        if (search) {
            topics = topics.filter(t => t.name.toLowerCase().includes(search) || (t.tags||[]).some(tag => tag.toLowerCase().includes(search)));
        }
        
        // Sort A-Z
        topics.sort((a,b) => a.name.localeCompare(b.name));

        const container = document.getElementById('bulk-topic-list');
        if (topics.length === 0) {
            container.innerHTML = '<p class="text-center text-slate-400 py-8 italic">No topics found.</p>';
            return;
        }

        container.innerHTML = topics.map(t => {
            const isChecked = bulkSelected.has(t.id);
            return `
                <div class="flex items-center p-2 rounded-lg hover:bg-white border border-transparent hover:border-slate-200 transition-all cursor-pointer" onclick="toggleBulkTopic('${t.id}')">
                    <input type="checkbox" ${isChecked ? 'checked' : ''} class="w-5 h-5 text-indigo-600 rounded border-slate-300 pointer-events-none">
                    <div class="ml-3">
                        <p class="text-sm font-bold text-slate-700">${t.name}</p>
                        <p class="text-[10px] text-slate-400 font-mono">${(t.tags||[]).join(', ')}</p>
                    </div>
                </div>
            `;
        }).join('');
        
        updateBulkCount();
    }

    function toggleBulkTopic(id) {
        if (bulkSelected.has(id)) bulkSelected.delete(id);
        else bulkSelected.add(id);
        renderBulkTopicList(); 
    }

    function toggleBulkAll() {
        const isChecked = document.getElementById('bulk-select-all').checked;
        const isAll = state.activeBlockId === 'all';
        let topics = isAll ? state.topics : state.topics.filter(t => t.blockId === state.activeBlockId);
        
        const search = document.getElementById('bulk-search').value.toLowerCase();
        if (search) {
            topics = topics.filter(t => t.name.toLowerCase().includes(search));
        }

        if (isChecked) {
            topics.forEach(t => bulkSelected.add(t.id));
        } else {
            topics.forEach(t => bulkSelected.delete(t.id));
        }
        renderBulkTopicList();
    }

    function updateBulkCount() {
        const countEl = document.getElementById('bulk-selection-count');
        countEl.innerText = `${bulkSelected.size} selected`;
        document.getElementById('bulk-next-btn').disabled = bulkSelected.size === 0;
    }

    function handleBulkNext() {
        if (bulkSelected.size === 0) return;

        const tbody = document.getElementById('bulk-input-list');
        const relevantTopics = state.topics.filter(t => bulkSelected.has(t.id)).sort((a,b) => a.name.localeCompare(b.name));
        
        tbody.innerHTML = relevantTopics.map(t => `
            <tr class="hover:bg-slate-50 group">
                <td class="px-4 py-3 border-b border-slate-50">
                    <p class="text-sm font-bold text-slate-700">${t.name}</p>
                </td>
                <td class="px-2 py-3 border-b border-slate-50 text-center">
                    <input type="number" min="0" max="10" step="0.1" data-id="${t.id}" data-field="sp3" class="w-full px-2 py-1.5 text-center text-sm font-bold rounded-lg border border-slate-200 focus:ring-2 focus:ring-indigo-500 bg-white" placeholder="-">
                </td>
                <td class="px-2 py-3 border-b border-slate-50 text-center">
                    <input type="number" min="0" max="10" step="0.1" data-id="${t.id}" data-field="quiz" class="w-full px-2 py-1.5 text-center text-sm font-bold rounded-lg border border-slate-200 focus:ring-2 focus:ring-indigo-500 bg-white" placeholder="-">
                </td>
                <td class="px-2 py-3 border-b border-slate-50">
                    <input type="text" data-id="${t.id}" data-field="note" class="w-full px-2 py-1.5 text-sm rounded-lg border border-slate-200 focus:ring-2 focus:ring-indigo-500 bg-white" placeholder="Note...">
                </td>
            </tr>
        `).join('');

        document.getElementById('bulk-step-1').classList.add('hidden');
        document.getElementById('bulk-step-2').classList.remove('hidden');
    }

    function handleBulkBack() {
        document.getElementById('bulk-step-2').classList.add('hidden');
        document.getElementById('bulk-step-1').classList.remove('hidden');
    }

    function handleBulkSubmit() {
        const date = document.getElementById('bulk-date').value;
        const inputs = document.querySelectorAll('#bulk-input-list input');
        const data = {}; // { topicId: { sp3, quiz, note } }

        inputs.forEach(input => {
            const id = input.dataset.id;
            const field = input.dataset.field;
            if (!data[id]) data[id] = {};
            data[id][field] = input.value;
        });

        let count = 0;
        Object.keys(data).forEach(topicId => {
            const entry = data[topicId];
            // Only save if at least one score is entered
            if (entry.sp3 !== "" || entry.quiz !== "") {
                const sp3 = entry.sp3 === "" ? 0 : parseFloat(entry.sp3);
                const quiz = entry.quiz === "" ? 0 : parseFloat(entry.quiz);
                state.passes.push({
                    id: 'p' + Date.now() + Math.random().toString(36).substr(2, 5),
                    topicId: topicId,
                    sp3: sp3,
                    quiz: quiz,
                    date: date,
                    note: entry.note || ""
                });
                count++;
            }
        });

        if (count > 0) {
            save();
            render();
            document.getElementById('bulk-pass-modal').classList.add('hidden');
            // Flash success?
        } else {
            alert("Please enter at least one score.");
        }
    }

    // Updated Handlers to use toggleModal
    function handleBlockChange(e) {
        const val = e.target.value;
        if (val === 'new_block_action') {
            toggleModal('block-modal');
            e.target.value = state.activeBlockId; 
        } else {
            state.activeBlockId = val;
            save();
        render();
        }
    }

function handleBlockSubmit(e) {
        e.preventDefault();
        const name = document.getElementById('block-name').value;
        const newId = 'b-' + Date.now();
        state.blocks.push({ id: newId, name: name, masteryGoal: 0 });
        state.activeBlockId = newId;
        toggleModal('block-modal');
        save();
        render();
    }

    function renameActiveBlock() {
        const block = getActiveBlock();
        if (!block) return;
        const newName = prompt("Rename Block:", block.name);
        if (newName && newName.trim() !== "") {
            block.name = newName.trim();
            save(); render(); // Render will update the selector options
        }
    }

    // --- Topic Operations ---
    function handleTopicSubmit(e) {
        e.preventDefault();
        const editId = document.getElementById('topic-edit-id').value;
        const name = document.getElementById('topic-name').value;
        const subject = document.getElementById('topic-subject').value;
        const tagsRaw = document.getElementById('topic-tags').value;
        const tags = tagsRaw.split(',').map(t => t.trim()).filter(t => t !== "");

        if (editId) {
            const index = state.topics.findIndex(t => t.id === editId);
            if (index !== -1) {
                state.topics[index] = { ...state.topics[index], name, subject, tags };
            }
        } else {
            state.topics.push({ 
                id: 't'+Date.now(), 
                blockId: state.activeBlockId,
                name, 
                subject,
                tags
            });
        }
        toggleModal('topic-modal');
        save();
        render();
    }

    function handleLectureSubmit(e) {
        e.preventDefault();
        const editId = document.getElementById('lecture-edit-id').value;
        const title = document.getElementById('lecture-title').value;
        const date = document.getElementById('lecture-date').value;
        const selectedTopics = Array.from(document.querySelectorAll('.topic-check:checked')).map(cb => cb.value);

        if (editId) {
            const index = state.lectures.findIndex(l => l.id === editId);
            if (index !== -1) state.lectures[index] = { ...state.lectures[index], title, date, topics: selectedTopics };
        } else {
            state.lectures.push({ 
                id: 'l'+Date.now(), 
                blockId: state.activeBlockId,
                title, 
                date, 
                topics: selectedTopics, 
                ingested: false 
            });
        }
        toggleModal('lecture-modal'); 
        save();
        render();
    }

    function handlePassSubmit(e) {
        e.preventDefault();
        const editId = document.getElementById('pass-edit-id').value;
        const topicId = document.getElementById('pass-topic-id').value;
        const sp3 = parseFloat(document.getElementById('pass-sp3').value);
        const quiz = parseFloat(document.getElementById('pass-quiz').value);
        const date = document.getElementById('pass-date').value;
        const note = document.getElementById('pass-note').value;

        if (editId) {
            const index = state.passes.findIndex(p => p.id === editId);
            if (index !== -1) state.passes[index] = { ...state.passes[index], topicId, sp3, quiz, date, note };
        } else state.passes.push({ id: 'p'+Date.now(), topicId, sp3, quiz, date, note });
        toggleModal('pass-modal'); 
        save();
        render();
    }

    function handleGoalSubmit(e) {
        e.preventDefault();
        const block = getActiveBlock();
        block.masteryGoal = parseFloat(document.getElementById('goal-mh-target').value);
        toggleModal('goal-modal'); 
        save();
        render();
    }

    /**
     * Updates which view is currently visible and highlights the sidebar.
     */
    function switchView(viewId) {
        state.activeViewId = viewId;
        save();
        render();
    }

    function getTopicStats(topicId) {
        const topicPasses = state.passes.filter(p => p.topicId === topicId);
        if (topicPasses.length === 0) return { mi: 0, count: 0 };
        const avgSp3 = topicPasses.reduce((acc, p) => acc + p.sp3, 0) / topicPasses.length;
        const avgQuiz = topicPasses.reduce((acc, p) => acc + p.quiz, 0) / topicPasses.length;
        return { mi: ((0.7 * avgSp3) + (0.3 * avgQuiz)).toFixed(2), count: topicPasses.length };
    }

    function calculateMh(topics) {
        const mis = topics.map(t => parseFloat(getTopicStats(t.id).mi)).filter(mi => mi > 0);
        return mis.length === 0 ? "0.0" : (mis.length / mis.reduce((acc, mi) => acc + (1/mi), 0)).toFixed(2);
    }

    function populateTopicSelectors() {
        const activeTopics = state.topics.filter(t => t.blockId === state.activeBlockId);
        document.getElementById('topic-selector-container').innerHTML = activeTopics.map(t => `
            <label class="flex items-center gap-2 p-1 hover:bg-slate-50 cursor-pointer text-sm">
                <input type="checkbox" value="${t.id}" class="topic-check w-4 h-4 text-indigo-600 rounded"> ${t.name}
            </label>
        `).join('') || '<p class="text-xs text-slate-400 italic">No topics in this block.</p>';
    }

    function populatePassTopicDropdown() {
        const activeTopics = state.topics.filter(t => t.blockId === state.activeBlockId);
        document.getElementById('pass-topic-id').innerHTML = activeTopics.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
    }

    function resetLectureFilters() {
        document.getElementById('lecture-search').value = "";
        document.getElementById('lecture-sort').value = "date-desc";
        document.getElementById('lecture-topic-filter').value = "all";
        document.getElementById('lecture-start-date').value = "";
        document.getElementById('lecture-end-date').value = "";
        render();
    }

    // --- Core Rendering ---





    function render() {
        const isAllBlocks = state.activeBlockId === 'all';
        const activeBlock = isAllBlocks ? null : getActiveBlock();
        
        const activeTopics = isAllBlocks ? state.topics : state.topics.filter(t => t.blockId === state.activeBlockId);
        const activeLectures = isAllBlocks ? state.lectures : state.lectures.filter(l => l.blockId === state.activeBlockId);
        
        const mh = calculateMh(activeTopics);
        const ingestedCount = activeLectures.filter(l => l.ingested).length;
        const masteredCount = activeTopics.filter(t => getTopicStats(t.id).mi >= 7).length;

        // Reactive update to components
        const statsEl = document.getElementById('mastery-stats');
        if (statsEl) statsEl.data = {
            mh,
            target: activeBlock ? activeBlock.masteryGoal : (isAllBlocks ? "Global" : "0.0"),
            ingestion: `${ingestedCount} / ${activeLectures.length}`,
            mastered: `${masteredCount} / ${activeTopics.length}`
        };

        const controls = document.getElementById('block-controls');
        if (controls) controls.data = { blocks: state.blocks, activeBlockId: state.activeBlockId, isAllBlocks };

        const navEl = document.getElementById('app-navigation');
        if (navEl) navEl.setAttribute('active-view', state.activeViewId);
        document.querySelectorAll('.view').forEach(el => el.classList.toggle('hidden', el.id !== 'view-' + state.activeViewId));

        const priorities = calculatePriority(state, activeTopics);
        const sidebar = document.getElementById('priority-sidebar');
        if (sidebar) sidebar.data = priorities[0];

        const dashboard = document.getElementById('view-dashboard');
        if (dashboard) dashboard.data = { state, activeTopics, isAllBlocks };

        const checklist = document.getElementById('view-checklist');
        if (checklist) checklist.data = { state, lectures: activeLectures };

        const lectures = document.getElementById('view-lectures');
        if (lectures) lectures.data = { state, lectures: activeLectures, activeTopics, isAllBlocks };

        const history = document.getElementById('view-history');
        if (history) history.data = { state, activeTopics, isAllBlocks };
    }

    // --- PRIORITY LOGIC ---
    function calculatePriority(state, activeTopics) {
        // Implementation of Harmonic Mean Priority Queue
        
        if (activeTopics.length === 0) return [];

        const bestPerSubject = {};
        
        // 1. Score and Group by Subject
        activeTopics.forEach(t => {
            const sub = (t.subject || 'General').trim();
            const stats = getTopicStats(t.id);
            const mi = parseFloat(stats.mi);
            
            // Find lowest Mi for this subject (The "Weakest Link" in that subject)
            if (!bestPerSubject[sub] || mi < bestPerSubject[sub].mi) {
                bestPerSubject[sub] = { 
                    topic: t, 
                    mi: mi,
                    count: stats.count 
                };
            }
        });

        // 2. Sort subjects by their lowest Mi (triage the weakest subjects first)
        // This ensures interleaving naturally because we pick the best candidate from EACH subject
        // and then rank those candidates against each other.
        const priorities = Object.values(bestPerSubject).sort((a, b) => a.mi - b.mi);

        // 3. Return top 3 unique subjects
        return priorities; //.slice(0, 3);
    }



    function setupEventListeners() {
        // Toolbar
        document.getElementById('export-data-btn').addEventListener('click', exportData);
        document.getElementById('clear-all-data-btn').addEventListener('click', clearAllData);
        document.getElementById('import-input-field').addEventListener('change', importData);

        // Forms
        document.getElementById('add-topic-form').addEventListener('submit', handleTopicSubmit);
        document.getElementById('add-edit-lecture-form').addEventListener('submit', handleLectureSubmit);
        document.getElementById('add-edit-pass-form').addEventListener('submit', handlePassSubmit);
        document.getElementById('set-goal-form').addEventListener('submit', handleGoalSubmit);
        document.getElementById('add-block-form').addEventListener('submit', handleBlockSubmit);
        document.getElementById('log-lecture-form').addEventListener('submit', handleLogLectureSubmit);

        // Modals & Cancel Buttons
        document.getElementById('cancel-topic-modal').addEventListener('click', () => toggleModal('topic-modal'));
        document.getElementById('cancel-lecture-modal').addEventListener('click', () => toggleModal('lecture-modal'));
        document.getElementById('cancel-pass-modal').addEventListener('click', () => toggleModal('pass-modal'));
        document.getElementById('cancel-goal-modal').addEventListener('click', () => toggleModal('goal-modal'));
        document.getElementById('cancel-block-modal').addEventListener('click', () => toggleModal('block-modal'));
        document.getElementById('cancel-log-lecture-modal').addEventListener('click', () => toggleModal('log-lecture-modal'));

        // Bulk Log Events
        const bulkLogBtn = document.getElementById('bulk-log-btn');
        if (bulkLogBtn) bulkLogBtn.addEventListener('click', openBulkLog);
        
        document.getElementById('bulk-select-all').addEventListener('change', toggleBulkAll);
        document.getElementById('bulk-search').addEventListener('input', renderBulkTopicList);
        document.getElementById('bulk-next-btn').addEventListener('click', handleBulkNext);
        document.getElementById('cancel-bulk-modal').addEventListener('click', () => document.getElementById('bulk-pass-modal').classList.add('hidden'));
        
        document.getElementById('bulk-back-btn').addEventListener('click', handleBulkBack);
        document.getElementById('bulk-submit-btn').addEventListener('click', handleBulkSubmit);
    }
    // Timer  JS deps
    // -- Timer Logic --
    let timerInterval = null;
    let seconds = 0;
    let isRunning = false;
    let mode = 'stopwatch'; 
    let pomodoroTime = 25 * 60;

    const display = document.getElementById('timerDisplay');
    const btnStart = document.getElementById('btnStart');
    const modeBtns = document.querySelectorAll('.mode-btn');

    function formatTime(totalSeconds) {
        const m = Math.floor(Math.abs(totalSeconds) / 60).toString().padStart(2, '0');
        const s = (Math.abs(totalSeconds) % 60).toString().padStart(2, '0');
        return `${m}:${s}`;
    }

    function updateDisplay() {
        if (mode === 'stopwatch') {
            display.innerText = formatTime(seconds);
        } else {
            const remaining = pomodoroTime - seconds;
            display.innerText = formatTime(remaining);
            if (remaining <= 0) {
                stopTimer();
                // In a real app, maybe play a sound here
            }
        }
    }

    function toggleTimer() {
        if (isRunning) {
            stopTimer();
        } else {
            startTimer();
        }
    }

    function startTimer() {
        isRunning = true;
        btnStart.innerText = "Pause";
        btnStart.classList.add('active');
        timerInterval = setInterval(() => {
            seconds++;
            updateDisplay();
        }, 1000);
    }

    function stopTimer() {
        isRunning = false;
        btnStart.innerText = "Resume";
        btnStart.classList.remove('active');
        clearInterval(timerInterval);
    }

    function resetTimer() {
        stopTimer();
        seconds = 0;
        btnStart.innerText = "Start Focus";
        updateDisplay();
    }

    function setTimerMode(newMode) {
        mode = newMode;
        if (newMode === 'pomodoro') pomodoroTime = 25 * 60;
        if (newMode === 'sprint') pomodoroTime = 60 * 60;
        resetTimer();
        modeBtns.forEach(btn => {
            const btnText = btn.innerText.toLowerCase();
            let isSelected = false;
            if (newMode === 'stopwatch') isSelected = btnText.includes('stopwatch');
            else if (newMode === 'pomodoro') isSelected = btnText.includes('pomodoro');
            else if (newMode === 'sprint') isSelected = btnText.includes('sprint');
            btn.classList.toggle('selected', isSelected);
        });
    }


    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>